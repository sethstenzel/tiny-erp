<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IndSurp ‚Äî Item Search</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; }

    body {
      margin: 0;
      background: #0f172a;
      font-family: 'Inter', system-ui, sans-serif;
      color: #e2e8f0;
      min-height: 100vh;
    }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    .app-header {
      display: flex; align-items: center; gap: 14px;
      padding: 0 20px; height: 56px; flex-shrink: 0;
      background: linear-gradient(90deg, #1e293b 0%, #0f1f35 100%);
      border-bottom: 1px solid #1e3a5f;
      box-shadow: 0 2px 12px rgba(0,0,0,0.35);
      position: sticky; top: 0; z-index: 50;
    }
    .brand-name {
      font-size: 22px; font-weight: 800; letter-spacing: 1px; white-space: nowrap;
      background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 80%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .page-title {
      font-size: 14px; font-weight: 600; color: #64748b;
      border-left: 1px solid #334155; padding-left: 14px; white-space: nowrap;
    }
    .header-spacer { flex: 1; }
    .btn-back {
      padding: 5px 12px; background: transparent; color: #94a3b8;
      border: 1px solid #334155; border-radius: 6px;
      font-family: inherit; font-size: 12px; font-weight: 600;
      text-decoration: none; white-space: nowrap;
      transition: color 0.15s, border-color 0.15s;
    }
    .btn-back:hover { color: #e2e8f0; border-color: #64748b; }
    .user-info { display: flex; align-items: center; gap: 10px; flex-shrink: 0; }
    .user-role-badge {
      font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px;
      padding: 3px 8px; border-radius: 99px;
    }
    .user-role-badge.admin { background: #1e3a5f; color: #60a5fa; border: 1px solid #2563eb; }
    .user-role-badge.worker { background: #1a2e1a; color: #86efac; border: 1px solid #16a34a; }
    .user-name { font-size: 13px; font-weight: 500; color: #94a3b8; }
    .btn-logout {
      padding: 5px 12px; background: transparent; color: #64748b;
      border: 1px solid #334155; border-radius: 6px;
      font-family: inherit; font-size: 12px; font-weight: 600; cursor: pointer;
      transition: color 0.15s, border-color 0.15s;
    }
    .btn-logout:hover { color: #e2e8f0; border-color: #64748b; }

    /* ‚îÄ‚îÄ Page content ‚îÄ‚îÄ */
    .page-content {
      max-width: 1300px;
      margin: 0 auto;
      padding: 28px 20px 60px;
    }

    /* ‚îÄ‚îÄ Search panel ‚îÄ‚îÄ */
    .search-panel {
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 12px;
      padding: 24px 24px 20px;
      margin-bottom: 24px;
    }
    .quick-row {
      display: flex; gap: 10px; margin-bottom: 20px;
    }
    .quick-row input {
      flex: 1; padding: 10px 14px;
      background: #0f172a; border: 1px solid #334155; border-radius: 8px;
      color: #e2e8f0; font-family: inherit; font-size: 14px; outline: none;
      transition: border-color 0.15s;
    }
    .quick-row input:focus { border-color: #3b82f6; }
    .quick-row input::placeholder { color: #475569; }

    .section-label {
      font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.7px;
      color: #475569; margin-bottom: 10px; margin-top: 4px;
    }
    .filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px 14px;
      margin-bottom: 14px;
    }
    .filter-field { display: flex; flex-direction: column; gap: 4px; }
    .filter-field label {
      font-size: 11px; font-weight: 600; color: #64748b;
      text-transform: uppercase; letter-spacing: 0.4px;
    }
    .filter-field input,
    .filter-field select {
      padding: 8px 10px;
      background: #0f172a; border: 1px solid #334155; border-radius: 7px;
      color: #e2e8f0; font-family: inherit; font-size: 13px; outline: none;
      transition: border-color 0.15s;
    }
    .filter-field input:focus,
    .filter-field select:focus { border-color: #3b82f6; }
    .filter-field input::placeholder { color: #475569; }
    .filter-field select option { background: #1e293b; }

    .divider {
      border: none; border-top: 1px solid #1e3a5f; margin: 16px 0 14px;
    }

    .action-row {
      display: flex; gap: 10px; align-items: center; margin-top: 4px;
    }
    .btn-search {
      padding: 9px 24px; background: #3b82f6; color: #fff; border: none;
      border-radius: 7px; font-family: inherit; font-size: 14px; font-weight: 600;
      cursor: pointer; transition: background 0.15s;
    }
    .btn-search:hover { background: #2563eb; }
    .btn-search:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-clear {
      padding: 9px 18px; background: transparent; color: #64748b;
      border: 1px solid #334155; border-radius: 7px;
      font-family: inherit; font-size: 14px; font-weight: 500; cursor: pointer;
      transition: color 0.15s, border-color 0.15s;
    }
    .btn-clear:hover { color: #e2e8f0; border-color: #64748b; }
    .search-status { font-size: 13px; color: #475569; margin-left: 4px; }

    /* ‚îÄ‚îÄ Results ‚îÄ‚îÄ */
    .results-header {
      display: flex; align-items: baseline; gap: 10px; margin-bottom: 12px;
    }
    .results-title {
      font-size: 15px; font-weight: 700; color: #e2e8f0;
    }
    .results-count {
      font-size: 13px; color: #475569;
    }

    .table-wrap {
      overflow-x: auto;
      border: 1px solid #334155;
      border-radius: 10px;
    }
    table {
      width: 100%; border-collapse: collapse; font-size: 13px;
    }
    thead th {
      padding: 11px 14px; text-align: left;
      background: #1e293b;
      font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
      color: #64748b; white-space: nowrap;
      border-bottom: 1px solid #334155;
    }
    tbody tr {
      border-bottom: 1px solid #1e293b;
      transition: background 0.1s;
    }
    tbody tr:last-child { border-bottom: none; }
    tbody tr:hover { background: #1e293b; }
    tbody td {
      padding: 10px 14px; vertical-align: top; color: #cbd5e1;
      max-width: 260px;
    }
    .cell-id { font-weight: 600; color: #e2e8f0; white-space: nowrap; }
    .cell-url a {
      color: #60a5fa; text-decoration: none; word-break: break-all;
    }
    .cell-url a:hover { text-decoration: underline; }
    .cell-notes { color: #94a3b8; font-style: italic; white-space: pre-wrap; word-break: break-word; min-width: 8rem; }
    .cell-url { min-width: 8rem; }
    .cell-location { white-space: nowrap; max-width: none; }
    .loc-text { font-size: 12px; color: #94a3b8; }
    .tags-cell { display: flex; flex-wrap: wrap; gap: 4px; }
    .tag-chip {
      display: inline-block; padding: 2px 8px;
      background: #1e3a5f; color: #60a5fa;
      border: 1px solid #1e4a7f; border-radius: 99px;
      font-size: 11px; font-weight: 500; white-space: nowrap;
    }
    .cell-date { white-space: nowrap; color: #64748b; font-size: 12px; }

    .empty-state {
      text-align: center; padding: 60px 20px;
      color: #475569; font-size: 14px;
    }
    .empty-state .icon { font-size: 36px; margin-bottom: 12px; opacity: 0.4; }
    .empty-state p { margin: 4px 0; }
    .empty-state .hint { font-size: 12px; color: #334155; margin-top: 8px; }

    .state-initial .icon { opacity: 0.3; }

    /* ‚îÄ‚îÄ Row action buttons ‚îÄ‚îÄ */
    .cell-actions { white-space: nowrap; vertical-align: middle; display: flex; gap: 6px; align-items: center; }
    .btn-edit-row {
      padding: 4px 10px; background: transparent; color: #60a5fa;
      border: 1px solid #1e3a5f; border-radius: 6px;
      font-family: inherit; font-size: 11px; font-weight: 600; cursor: pointer;
      transition: background 0.15s, border-color 0.15s, color 0.15s;
    }
    .btn-edit-row:hover { background: #1e3a5f; color: #93c5fd; border-color: #3b82f6; }
    .btn-delete-row {
      padding: 4px 10px; background: transparent; color: #f87171;
      border: 1px solid #7f1d1d; border-radius: 6px;
      font-family: inherit; font-size: 11px; font-weight: 600; cursor: pointer;
      transition: background 0.15s, border-color 0.15s, color 0.15s;
    }
    .btn-delete-row:hover { background: #7f1d1d; color: #fca5a5; border-color: #ef4444; }

    /* ‚îÄ‚îÄ Confirm delete modal ‚îÄ‚îÄ */
    .modal-overlay {
      display: none; position: fixed; inset: 0; z-index: 200;
      background: rgba(0,0,0,0.65); align-items: center; justify-content: center;
    }
    .modal-overlay.open { display: flex; }
    .confirm-modal {
      background: #1e293b; border: 1px solid #334155; border-radius: 12px;
      padding: 28px 28px 22px; max-width: 380px; width: 90%;
      box-shadow: 0 8px 40px rgba(0,0,0,0.5);
    }
    .confirm-modal-title {
      font-size: 16px; font-weight: 700; color: #e2e8f0; margin-bottom: 10px;
    }
    .confirm-modal-msg {
      font-size: 13px; color: #94a3b8; margin-bottom: 22px; line-height: 1.5;
    }
    .confirm-modal-actions { display: flex; gap: 10px; justify-content: flex-end; }
    .btn-confirm-cancel {
      padding: 7px 16px; background: transparent; color: #94a3b8;
      border: 1px solid #334155; border-radius: 7px;
      font-family: inherit; font-size: 13px; font-weight: 500; cursor: pointer;
      transition: color 0.15s, border-color 0.15s;
    }
    .btn-confirm-cancel:hover { color: #e2e8f0; border-color: #64748b; }
    .btn-confirm-delete {
      padding: 7px 16px; background: #991b1b; color: #fca5a5;
      border: 1px solid #b91c1c; border-radius: 7px;
      font-family: inherit; font-size: 13px; font-weight: 600; cursor: pointer;
      transition: background 0.15s;
    }
    .btn-confirm-delete:hover { background: #7f1d1d; }

    /* ‚îÄ‚îÄ Edit item modal ‚îÄ‚îÄ */
    #editModal { pointer-events: none; }
    #editModal .edit-modal { pointer-events: auto; }
    .edit-modal {
      background: #1e293b; border: 1px solid #334155; border-radius: 12px;
      padding: 28px 28px 22px; max-width: 560px; width: 95%;
      box-shadow: 0 8px 40px rgba(0,0,0,0.5); max-height: 90vh; overflow-y: auto;
    }
    .edit-modal-title {
      font-size: 16px; font-weight: 700; color: #e2e8f0; margin-bottom: 20px;
    }
    .edit-form-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 12px 16px; margin-bottom: 22px;
    }
    .edit-form-grid .full-width { grid-column: 1 / -1; }
    .edit-field { display: flex; flex-direction: column; gap: 5px; }
    .edit-field label {
      font-size: 11px; font-weight: 600; color: #64748b;
      text-transform: uppercase; letter-spacing: 0.4px;
    }
    .edit-field input,
    .edit-field textarea {
      padding: 8px 10px;
      background: #0f172a; border: 1px solid #334155; border-radius: 7px;
      color: #e2e8f0; font-family: inherit; font-size: 13px; outline: none;
      transition: border-color 0.15s;
    }
    .edit-field input:focus,
    .edit-field textarea:focus { border-color: #3b82f6; }
    .edit-field textarea { resize: vertical; min-height: 70px; }
    .edit-modal-actions { display: flex; gap: 10px; justify-content: flex-end; }
    .btn-edit-save {
      padding: 7px 18px; background: #3b82f6; color: #fff; border: none;
      border-radius: 7px; font-family: inherit; font-size: 13px; font-weight: 600;
      cursor: pointer; transition: background 0.15s;
    }
    .btn-edit-save:hover { background: #2563eb; }
    .btn-edit-save:disabled { opacity: 0.6; cursor: not-allowed; }
    .btn-edit-cancel {
      padding: 7px 16px; background: transparent; color: #94a3b8;
      border: 1px solid #334155; border-radius: 7px;
      font-family: inherit; font-size: 13px; font-weight: 500; cursor: pointer;
      transition: color 0.15s, border-color 0.15s;
    }
    .btn-edit-cancel:hover { color: #e2e8f0; border-color: #64748b; }
    .edit-error { font-size: 12px; color: #f87171; margin-right: auto; align-self: center; }
    /* ‚îÄ‚îÄ Mobile ‚îÄ‚îÄ */
    @media (max-width: 640px) {
      /* Header ‚Äî hide non-essential text, reduce padding */
      .app-header { padding: 0 12px; gap: 8px; }
      .page-title { display: none; }
      .user-name  { display: none; }
      .brand-name { font-size: 18px; }
      .user-info  { gap: 6px; }

      /* Page & panel padding */
      .page-content { padding: 14px 10px 40px; }
      .search-panel { padding: 14px 12px; }

      /* Quick-row: stack input above buttons */
      .quick-row { flex-wrap: wrap; }
      .quick-row input { min-width: 0; }

      /* Action row: allow wrap so status text doesn't push buttons off */
      .action-row { flex-wrap: wrap; }

      /* Table: tighter cells, allow horizontal scroll (already enabled) */
      thead th { padding: 8px 10px; }
      tbody td  { padding: 8px 10px; font-size: 12px; }
      .cell-location { white-space: normal; }

      /* Row action buttons: stack vertically so they don't widen the column */
      .cell-actions { flex-direction: column; gap: 4px; align-items: flex-start; }

      /* Edit modal: single column, tighter padding */
      .edit-form-grid { grid-template-columns: 1fr; }
      .edit-modal { padding: 20px 14px 16px; width: 98%; }

      /* Confirm modal */
      .confirm-modal { padding: 20px 16px 16px; }
    }
  </style>
</head>
<body>

  <!-- Header -->
  <header class="app-header">
    <div class="brand-name">IndSurp</div>
    <div class="page-title">Item Search</div>
    <div class="header-spacer"></div>
    <a class="btn-back" href="/">‚Üê Warehouse</a>
    <div class="user-info">
      <span class="user-role-badge" id="roleBadge"></span>
      <span class="user-name" id="userName"></span>
      <button class="btn-logout" id="logoutBtn">Sign Out</button>
    </div>
  </header>

  <div class="page-content">

    <!-- Search panel -->
    <div class="search-panel">

      <!-- Quick search -->
      <div class="quick-row">
        <input type="text" id="q" placeholder="Quick search across all fields‚Ä¶" />
        <button class="btn-search" id="searchBtn">Search</button>
        <button class="btn-clear" id="clearBtn">Clear</button>
      </div>

      <!-- Item detail filters -->
      <div class="section-label">Item Details</div>
      <div class="filters-grid" id="itemFilters">
        <div class="filter-field">
          <label>Item ID</label>
          <input type="text" id="f_item_id" placeholder="e.g. SKU-001" />
        </div>
        <div class="filter-field">
          <label>Item Type</label>
          <input type="text" id="f_item_type" placeholder="e.g. Electronics" />
        </div>
        <div class="filter-field">
          <label>Category</label>
          <input type="text" id="f_category" placeholder="e.g. Accessories" />
        </div>
        <div class="filter-field">
          <label>Tags</label>
          <input type="text" id="f_tags" placeholder="e.g. fragile" />
        </div>
        <div class="filter-field">
          <label>URL contains</label>
          <input type="text" id="f_url" placeholder="e.g. supplier.com" />
        </div>
        <div class="filter-field">
          <label>Notes contain</label>
          <input type="text" id="f_notes" placeholder="keyword in notes" />
        </div>
      </div>

      <hr class="divider">

      <!-- Location filters -->
      <div class="section-label">Location</div>
      <div class="filters-grid">
        <div class="filter-field">
          <label>Location Type</label>
          <select id="f_location_type">
            <option value="">Any</option>
            <option value="shelf">Shelf</option>
            <option value="zone">Zone</option>
          </select>
        </div>
        <div class="filter-field">
          <label>Warehouse</label>
          <input type="text" id="f_warehouse_name" placeholder="e.g. Main Warehouse" />
        </div>
        <div class="filter-field">
          <label>Pallet Rack Row</label>
          <input type="text" id="f_pallet_rack_row" placeholder="e.g. A" />
        </div>
        <div class="filter-field">
          <label>Pallet Rack Label</label>
          <input type="text" id="f_pallet_rack_label" placeholder="e.g. Electronics Row" />
        </div>
        <div class="filter-field">
          <label>Shelf Label</label>
          <input type="text" id="f_shelf_label" placeholder="e.g. Top Shelf" />
        </div>
        <div class="filter-field">
          <label>Zone Label</label>
          <input type="text" id="f_zone_label" placeholder="e.g. Receiving" />
        </div>
      </div>

      <hr class="divider">

      <!-- Date filters -->
      <div class="section-label">Date Added</div>
      <div class="filters-grid">
        <div class="filter-field">
          <label>From</label>
          <input type="date" id="f_date_from" />
        </div>
        <div class="filter-field">
          <label>To</label>
          <input type="date" id="f_date_to" />
        </div>
      </div>

      <div class="action-row">
        <button class="btn-search" id="searchBtn2">Search</button>
        <button class="btn-clear" id="clearBtn2">Clear</button>
        <span class="search-status" id="searchStatus"></span>
      </div>
    </div>

    <!-- Results -->
    <div id="resultsSection">
      <div class="empty-state state-initial">
        <div class="icon">üîç</div>
        <p>Enter search terms above and click <strong>Search</strong></p>
        <p class="hint">Leave all fields blank to retrieve every item</p>
      </div>
    </div>

  </div>

  <!-- Edit item modal -->
  <div class="modal-overlay" id="editModal">
    <div class="edit-modal">
      <div class="edit-modal-title">Edit Item</div>
      <div class="edit-form-grid">
        <div class="edit-field">
          <label>Item ID</label>
          <input type="text" id="edit_item_id" />
        </div>
        <div class="edit-field">
          <label>Item Type</label>
          <input type="text" id="edit_item_type" />
        </div>
        <div class="edit-field">
          <label>Category</label>
          <input type="text" id="edit_category" />
        </div>
        <div class="edit-field">
          <label>Tags (comma-separated)</label>
          <input type="text" id="edit_tags" />
        </div>
        <div class="edit-field full-width">
          <label>URL</label>
          <input type="text" id="edit_url" />
        </div>
        <div class="edit-field full-width">
          <label>Notes</label>
          <textarea id="edit_notes"></textarea>
        </div>
      </div>
      <div class="edit-modal-actions">
        <span class="edit-error" id="editError"></span>
        <button class="btn-edit-cancel" id="editCancelBtn">Cancel</button>
        <button class="btn-edit-save" id="editSaveBtn">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Confirm delete modal -->
  <div class="modal-overlay" id="deleteModal">
    <div class="confirm-modal">
      <div class="confirm-modal-title">Delete Item</div>
      <div class="confirm-modal-msg" id="deleteModalMsg"></div>
      <div class="confirm-modal-actions">
        <button class="btn-confirm-cancel" id="deleteCancelBtn">Cancel</button>
        <button class="btn-confirm-delete" id="deleteConfirmBtn">Delete</button>
      </div>
    </div>
  </div>

  <script>
    // ‚îÄ‚îÄ Auth ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let currentUser = null;
    let itemsCache = {}; // id -> item object

    async function checkAuth() {
      const resp = await fetch('/api/me');
      if (resp.status === 401) { window.location.href = '/login'; return false; }
      currentUser = await resp.json();
      document.getElementById('roleBadge').textContent = currentUser.role;
      document.getElementById('roleBadge').className = 'user-role-badge ' + currentUser.role;
      document.getElementById('userName').textContent = currentUser.username;
      return true;
    }

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await fetch('/api/logout', { method: 'POST' });
      window.location.href = '/login';
    });

    // ‚îÄ‚îÄ Search ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function stripLeadingZeros(s) { return s.replace(/^0+(?=.)/, ''); }

    function getParams() {
      const p = new URLSearchParams();
      const add = (id, key) => {
        const v = stripLeadingZeros(document.getElementById(id).value.trim());
        if (v) p.set(key, v);
      };
      add('q',                'q');
      add('f_item_id',        'item_id');
      add('f_item_type',      'item_type');
      add('f_category',       'category');
      add('f_tags',           'tags');
      add('f_url',            'url');
      add('f_notes',          'notes');
      add('f_location_type',  'location_type');
      add('f_warehouse_name',    'warehouse_name');
      add('f_pallet_rack_row',   'pallet_rack_row');
      add('f_pallet_rack_label', 'pallet_rack_label');
      add('f_shelf_label',    'shelf_label');
      add('f_zone_label',     'zone_label');
      add('f_date_from',      'date_from');
      add('f_date_to',        'date_to');
      return p;
    }

    function clearAll() {
      ['q','f_item_id','f_item_type','f_category','f_tags','f_url','f_notes',
       'f_warehouse_name','f_pallet_rack_row','f_pallet_rack_label','f_shelf_label','f_zone_label',
       'f_date_from','f_date_to'].forEach(id => document.getElementById(id).value = '');
      document.getElementById('f_location_type').value = '';
      document.getElementById('searchStatus').textContent = '';
      document.getElementById('resultsSection').innerHTML = `
        <div class="empty-state state-initial">
          <div class="icon">üîç</div>
          <p>Enter search terms above and click <strong>Search</strong></p>
          <p class="hint">Leave all fields blank to retrieve every item</p>
        </div>`;
    }

    function formatDate(iso) {
      if (!iso) return '‚Äî';
      try {
        const d = new Date(iso);
        return d.toLocaleDateString(undefined, { year:'numeric', month:'short', day:'numeric' });
      } catch { return iso.slice(0, 10); }
    }

    function formatLocation(item) {
      const parts = [];
      if (item.warehouse_name) parts.push(`WH: ${item.warehouse_name}`);
      if (item.location_type === 'zone') {
        if (item.zone_label) parts.push(`Z: ${item.zone_label}`);
      } else {
        if (item.pallet_rack_label) parts.push(`PR: ${item.pallet_rack_label}`);
        if (item.subsection_number != null)
          parts.push(`SUB: ${item.subsection_name || item.subsection_number}`);
        if (item.shelf_label) parts.push(`SH: ${item.shelf_label}`);
      }
      if (item.item_id)   parts.push(`ID: ${item.item_id}`);
      if (item.item_type) parts.push(`T: ${item.item_type}`);
      return `<span class="loc-text">${esc(parts.join(' | '))}</span>`;
    }

    function renderTags(raw) {
      if (!raw) return '‚Äî';
      const chips = raw.split(',').map(t => t.trim()).filter(Boolean)
        .map(t => `<span class="tag-chip">${esc(t)}</span>`).join('');
      return chips ? `<div class="tags-cell">${chips}</div>` : '‚Äî';
    }

    function esc(s) {
      return String(s)
        .replace(/&/g,'&amp;').replace(/</g,'&lt;')
        .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function renderResults(items) {
      itemsCache = {};
      items.forEach(item => { itemsCache[item.id] = item; });
      const section = document.getElementById('resultsSection');
      if (items.length === 0) {
        section.innerHTML = `
          <div class="empty-state">
            <div class="icon">üì≠</div>
            <p>No items matched your search</p>
            <p class="hint">Try broadening your filters</p>
          </div>`;
        return;
      }

      const rows = items.map(item => `
        <tr data-item-id="${item.id}">
          <td class="cell-id">${esc(item.item_id)}</td>
          <td>${esc(item.item_type || '‚Äî')}</td>
          <td>${esc(item.category || '‚Äî')}</td>
          <td>${renderTags(item.tags)}</td>
          <td class="cell-url">${item.url
            ? `<a href="${esc(item.url)}" target="_blank" rel="noopener noreferrer">${esc(item.url)}</a>`
            : '‚Äî'}</td>
          <td class="cell-notes">${esc(item.notes || '‚Äî')}</td>
          <td class="cell-location">${formatLocation(item)}</td>
          <td class="cell-date">${formatDate(item.added_at)}</td>
          <td class="cell-actions">
            <button class="btn-edit-row" onclick="openEditModal(${item.id})">Edit</button>
            <button class="btn-delete-row" onclick="openDeleteConfirm(${item.id}, '${esc(item.item_id)}')">Delete</button>
          </td>
        </tr>`).join('');

      section.innerHTML = `
        <div class="results-header">
          <span class="results-title">Results</span>
          <span class="results-count">${items.length} item${items.length !== 1 ? 's' : ''} found</span>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Item ID</th>
                <th>Type</th>
                <th>Category</th>
                <th>Tags</th>
                <th>URL</th>
                <th>Notes</th>
                <th>Location</th>
                <th>Added</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>`;
    }

    async function doSearch() {
      const params = getParams();
      const statusEl = document.getElementById('searchStatus');
      [document.getElementById('searchBtn'), document.getElementById('searchBtn2')]
        .forEach(b => b.disabled = true);
      statusEl.textContent = 'Searching‚Ä¶';
      try {
        const resp = await fetch('/api/search?' + params.toString());
        if (resp.status === 401) { window.location.href = '/login'; return; }
        const items = await resp.json();
        renderResults(items);
        statusEl.textContent = '';
        document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
      } catch (err) {
        statusEl.textContent = 'Search failed.';
        console.error(err);
      } finally {
        [document.getElementById('searchBtn'), document.getElementById('searchBtn2')]
          .forEach(b => b.disabled = false);
      }
    }

    // ‚îÄ‚îÄ Event wiring ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    document.getElementById('searchBtn').addEventListener('click', doSearch);
    document.getElementById('searchBtn2').addEventListener('click', doSearch);
    document.getElementById('clearBtn').addEventListener('click', clearAll);
    document.getElementById('clearBtn2').addEventListener('click', clearAll);

    // Enter key on any input triggers search
    document.querySelectorAll('input').forEach(el => {
      el.addEventListener('keydown', e => { if (e.key === 'Enter') doSearch(); });
    });

    // ‚îÄ‚îÄ Edit item ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let editingItemId = null;

    function openEditModal(itemDbId) {
      const item = itemsCache[itemDbId];
      if (!item) return;
      editingItemId = itemDbId;
      document.getElementById('edit_item_id').value   = item.item_id   || '';
      document.getElementById('edit_item_type').value = item.item_type || '';
      document.getElementById('edit_category').value  = item.category  || '';
      document.getElementById('edit_tags').value      = item.tags      || '';
      document.getElementById('edit_url').value       = item.url       || '';
      document.getElementById('edit_notes').value     = item.notes     || '';
      document.getElementById('editError').textContent = '';
      document.getElementById('editModal').classList.add('open');
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.remove('open');
      editingItemId = null;
    }

    document.getElementById('editCancelBtn').addEventListener('click', closeEditModal);

    document.getElementById('editSaveBtn').addEventListener('click', async () => {
      if (!editingItemId) return;
      const saveBtn = document.getElementById('editSaveBtn');
      const errorEl = document.getElementById('editError');
      const itemId = document.getElementById('edit_item_id').value.trim().replace(/^0+(?=.)/, '').toUpperCase();
      if (!itemId || itemId.length < 3) { errorEl.textContent = 'Item ID must be at least 3 characters.'; return; }
      saveBtn.disabled = true;
      errorEl.textContent = '';
      const cached = itemsCache[editingItemId];
      const payload = {
        item_id:    itemId,
        item_type:  document.getElementById('edit_item_type').value.trim().toUpperCase(),
        category:   document.getElementById('edit_category').value.trim().toUpperCase(),
        tags:       document.getElementById('edit_tags').value.trim().toUpperCase(),
        url:        document.getElementById('edit_url').value.trim(),
        notes:      document.getElementById('edit_notes').value.trim(),
        // preserve location fields unchanged
        added_at:          cached.added_at          || '',
        location_type:     cached.location_type     || 'shelf',
        warehouse_id:      cached.warehouse_id      ?? null,
        warehouse_name:    cached.warehouse_name    || '',
        pallet_rack_id:    cached.pallet_rack_id    ?? null,
        pallet_rack_label: cached.pallet_rack_label || '',
        pallet_rack_row:   cached.pallet_rack_row   || '',
        subsection_id:     cached.subsection_id     ?? null,
        subsection_number: cached.subsection_number ?? null,
        subsection_name:   cached.subsection_name   || '',
        shelf_id:          cached.shelf_id          ?? null,
        shelf_label:       cached.shelf_label       || '',
        zone_id:           cached.zone_id           ?? null,
        zone_label:        cached.zone_label        || '',
      };
      try {
        const resp = await fetch(`/api/items/${editingItemId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (resp.status === 401) { window.location.href = '/login'; return; }
        if (!resp.ok) { errorEl.textContent = 'Save failed. Please try again.'; return; }
        // Update cache and re-render row in-place
        Object.assign(itemsCache[editingItemId], payload);
        const row = document.querySelector(`tr[data-item-id="${editingItemId}"]`);
        if (row) {
          const updated = itemsCache[editingItemId];
          row.cells[0].innerHTML = `<span class="cell-id" style="font-weight:600;color:#e2e8f0">${esc(updated.item_id)}</span>`;
          row.cells[1].textContent = updated.item_type || '‚Äî';
          row.cells[2].textContent = updated.category  || '‚Äî';
          row.cells[3].innerHTML   = renderTags(updated.tags);
          row.cells[4].innerHTML   = updated.url
            ? `<a href="${esc(updated.url)}" target="_blank" rel="noopener noreferrer">${esc(updated.url)}</a>`
            : '‚Äî';
          row.cells[5].textContent = updated.notes || '‚Äî';
        }
        closeEditModal();
      } catch (err) {
        console.error(err);
        errorEl.textContent = 'Save failed. Please try again.';
      } finally {
        saveBtn.disabled = false;
      }
    });

    // ‚îÄ‚îÄ Delete item ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let pendingDeleteId  = null;
    let pendingDeleteRow = null;

    function openDeleteConfirm(itemDbId, itemLabel) {
      pendingDeleteId  = itemDbId;
      pendingDeleteRow = document.querySelector(`tr[data-item-id="${itemDbId}"]`);
      document.getElementById('deleteModalMsg').textContent =
        `Are you sure you want to permanently delete "${itemLabel}" from inventory? This cannot be undone.`;
      document.getElementById('deleteModal').classList.add('open');
    }

    function closeDeleteModal() {
      document.getElementById('deleteModal').classList.remove('open');
      pendingDeleteId  = null;
      pendingDeleteRow = null;
    }

    document.getElementById('deleteCancelBtn').addEventListener('click', closeDeleteModal);
    document.getElementById('deleteModal').addEventListener('click', e => {
      if (e.target === document.getElementById('deleteModal')) closeDeleteModal();
    });

    document.getElementById('deleteConfirmBtn').addEventListener('click', async () => {
      if (!pendingDeleteId) return;
      const id  = pendingDeleteId;
      const row = pendingDeleteRow;
      closeDeleteModal();
      try {
        const resp = await fetch(`/api/items/${id}`, { method: 'DELETE' });
        if (resp.status === 401) { window.location.href = '/login'; return; }
        if (!resp.ok) { alert('Delete failed. Please try again.'); return; }
        if (row) row.remove();
        // Update results count
        const countEl = document.querySelector('.results-count');
        if (countEl) {
          const remaining = document.querySelectorAll('tbody tr').length;
          countEl.textContent = `${remaining} item${remaining !== 1 ? 's' : ''} found`;
        }
      } catch (err) {
        console.error(err);
        alert('Delete failed. Please try again.');
      }
    });

    // ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    checkAuth().then(ok => { if (ok) document.getElementById('q').focus(); });
  </script>
</body>
</html>
