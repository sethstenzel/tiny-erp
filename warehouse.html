<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IndSurp ‚Äî Warehouse Layout</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    /* ‚ïê‚ïê RESET ‚ïê‚ïê */
    * { box-sizing: border-box; }

    /* ‚ïê‚ïê LAYOUT ‚ïê‚ïê */
    body {
      display: flex; flex-direction: column;
      height: 100vh; margin: 0; padding: 0;
      background: #0f172a;
      font-family: 'Inter', system-ui, sans-serif;
      user-select: none; overflow: hidden; gap: 0;
    }

    /* ‚îÄ‚îÄ App Header ‚îÄ‚îÄ */
    .app-header {
      display: flex; align-items: center; gap: 14px;
      padding: 0 18px; height: 56px; flex-shrink: 0;
      background: linear-gradient(90deg, #1e293b 0%, #0f1f35 100%);
      border-bottom: 1px solid #1e3a5f;
      box-shadow: 0 2px 12px rgba(0,0,0,0.35);
      z-index: 50;
    }
    .brand-name {
      font-size: 24px; font-weight: 800; letter-spacing: 1px;
      background: linear-gradient(135deg, #60a5fa 0%, #a78bfa 80%);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text; white-space: nowrap; flex-shrink: 0;
    }

    /* ‚îÄ‚îÄ Search bar (inside header) ‚îÄ‚îÄ */
    .search-bar { flex: 1; display: flex; gap: 8px; align-items: flex-start; flex-wrap: wrap; min-width: 0; }
    .search-input-wrap { display: flex; gap: 8px; flex: 1; min-width: 0; }
    .search-input-wrap input {
      flex: 1; min-width: 0; padding: 8px 14px;
      border: 1px solid #334155; border-radius: 8px;
      font-size: 14px; outline: none; color: #e2e8f0;
      background: #0f172a; font-family: inherit; user-select: text;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    .search-input-wrap input::placeholder { color: #475569; }
    .search-input-wrap input:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.18); }
    .btn-search {
      padding: 8px 18px; background: #3b82f6; color: white; border: none;
      border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer;
      white-space: nowrap; font-family: inherit; flex-shrink: 0;
      transition: background 0.2s, transform 0.1s;
    }
    .btn-search:hover { background: #2563eb; }
    .btn-search:active { transform: scale(0.96); }
    .btn-clear-search {
      padding: 8px 14px; background: #1e293b; color: #94a3b8;
      border: 1px solid #334155; border-radius: 8px; font-size: 14px;
      font-weight: 600; cursor: pointer; font-family: inherit; flex-shrink: 0;
      transition: background 0.2s, color 0.15s;
    }
    .btn-clear-search:hover { background: #334155; color: #e2e8f0; }
    .search-results { width: 100%; display: flex; flex-direction: column; gap: 5px; margin-top: 6px; position: absolute; top: 56px; left: 18px; right: 18px; z-index: 200; }
    .search-results.hidden { display: none; }
    .search-result-card {
      background: #1e293b; border-radius: 9px; border-left: 3px solid #10b981;
      padding: 9px 14px; box-shadow: 0 4px 16px rgba(0,0,0,0.4);
      backdrop-filter: blur(8px);
    }
    .search-result-card.not-found { border-left-color: #ef4444; color: #94a3b8; font-size: 13px; }
    .result-line { font-size: 12px; color: #cbd5e1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .result-line .lbl { font-weight: 700; color: #64748b; margin-right: 2px; }
    .result-line .sep { color: #334155; margin: 0 5px; }

    /* ‚îÄ‚îÄ App main area ‚îÄ‚îÄ */
    .app-main { flex: 1; min-height: 0; display: flex; flex-direction: column; padding: 10px 12px; }

    /* ‚îÄ‚îÄ Warehouse panel (wraps tab bar + viewport) ‚îÄ‚îÄ */
    .warehouse-panel { flex: 1; min-height: 0; display: flex; flex-direction: column; width: 100%; }

    /* ‚îÄ‚îÄ Tab bar ‚îÄ‚îÄ */
    .tab-bar {
      display: flex; align-items: flex-end; gap: 2px; padding: 5px 8px 0;
      flex-shrink: 0; overflow-x: auto;
      background: #162032; border: 1px solid #1e3a5f; border-bottom: none;
      border-radius: 10px 10px 0 0; scrollbar-width: thin; scrollbar-color: #334155 transparent;
    }
    .tab {
      display: flex; align-items: center; gap: 5px; padding: 6px 14px;
      background: #0f172a; border: 1px solid #1e3a5f; border-bottom: none;
      border-radius: 7px 7px 0 0; cursor: pointer; font-size: 12px;
      font-weight: 600; color: #475569; user-select: none; white-space: nowrap;
      flex-shrink: 0; transition: background 0.15s, color 0.15s;
    }
    .tab:hover { background: #1e293b; color: #94a3b8; }
    .tab.active { background: #1e3a5f; color: #93c5fd; border-color: #3b82f6; border-bottom-color: #1e3a5f; }
    .tab-close {
      background: none; border: none; cursor: pointer; padding: 0 2px;
      font-size: 12px; color: #475569; border-radius: 3px; line-height: 1;
      transition: background 0.15s, color 0.15s;
    }
    .tab-close:hover { background: rgba(239,68,68,0.2); color: #f87171; }
    .tab-name-input {
      border: none; background: transparent; outline: none;
      font-size: 12px; font-weight: 600; color: #93c5fd; min-width: 40px; max-width: 130px;
      font-family: inherit;
    }
    .btn-add-tab {
      padding: 4px 10px; background: none; border: none; cursor: pointer;
      font-size: 20px; color: #334155; align-self: center; border-radius: 5px; line-height: 1;
      transition: background 0.15s, color 0.15s;
    }
    .btn-add-tab:hover { background: rgba(59,130,246,0.15); color: #60a5fa; }

    /* ‚îÄ‚îÄ Viewport ‚îÄ‚îÄ */
    .viewport {
      flex: 1; min-height: 0; width: 100%; overflow: hidden; position: relative;
      background: #1e293b; border: 1px solid #1e3a5f; border-top: none;
      border-radius: 0 0 10px 10px;
    }
    .viewport.panning { cursor: grabbing !important; }

    /* ‚îÄ‚îÄ Pan/zoom layer ‚îÄ‚îÄ */
    .pan-zoom-layer { position: absolute; top: 0; left: 0; transform-origin: 0 0; will-change: transform; }

    /* ‚îÄ‚îÄ Warehouse ‚îÄ‚îÄ */
    .warehouse {
      width: 800px; height: 500px; border: 5px solid #3b82f6;
      position: relative; overflow: visible; background: #f8fafc; cursor: default;
      box-shadow: 0 0 0 1px rgba(59,130,246,0.3), 0 8px 40px rgba(0,0,0,0.5);
      border-radius: 2px;
    }
    .warehouse.drawing-mode { cursor: crosshair; }
    .warehouse.drag-over { outline: 3px dashed #60a5fa; outline-offset: -4px; }

    /* ‚îÄ‚îÄ Warehouse wrapper ‚îÄ‚îÄ */
    .warehouse-wrapper { display: inline-block; position: relative; }

    /* ‚îÄ‚îÄ Warehouse resize handles ‚îÄ‚îÄ */
    .rh {
      position: absolute; width: 12px; height: 12px; z-index: 200;
      background: #1e293b; border: 2px solid #3b82f6; border-radius: 3px; display: none;
    }
    .edit-mode .rh  { display: block; }
    .rh-nw { top:-6px;    left:-6px;                             cursor: nw-resize; }
    .rh-n  { top:-6px;    left:50%;  transform:translateX(-50%); cursor: n-resize;  }
    .rh-ne { top:-6px;    right:-6px;                            cursor: ne-resize; }
    .rh-e  { top:50%;     right:-6px; transform:translateY(-50%);cursor: e-resize;  }
    .rh-se { bottom:-6px; right:-6px;                            cursor: se-resize; }
    .rh-s  { bottom:-6px; left:50%;  transform:translateX(-50%); cursor: s-resize;  }
    .rh-sw { bottom:-6px; left:-6px;                             cursor: sw-resize; }
    .rh-w  { top:50%;     left:-6px;  transform:translateY(-50%);cursor: w-resize;  }

    /* Isle cursor in edit mode */
    .edit-mode .isle { cursor: move; }
    .edit-mode .zone { cursor: move; }

    /* ‚îÄ‚îÄ Entity resize/rotate handles ‚îÄ‚îÄ */
    .edit-handle {
      position: absolute; width: 10px; height: 10px; z-index: 300;
      background: #1e293b; border: 2px solid #3b82f6; border-radius: 2px;
      transform: translate(-50%, -50%); pointer-events: none; display: none;
    }
    .edit-mode .edit-handle { display: block; pointer-events: all; }
    .edit-handle[data-edge="nw"] { cursor: nw-resize; }
    .edit-handle[data-edge="n"]  { cursor:  n-resize; }
    .edit-handle[data-edge="ne"] { cursor: ne-resize; }
    .edit-handle[data-edge="e"]  { cursor:  e-resize; }
    .edit-handle[data-edge="se"] { cursor: se-resize; }
    .edit-handle[data-edge="s"]  { cursor:  s-resize; }
    .edit-handle[data-edge="sw"] { cursor: sw-resize; }
    .edit-handle[data-edge="w"]  { cursor:  w-resize; }
    .edit-handle[data-edge="rotate"] {
      width: 14px !important; height: 14px !important;
      background: #10b981; border-color: #059669; border-radius: 50%; cursor: grab;
    }
    .edit-handle[data-edge="rotate"]:active { cursor: grabbing; }

    /* ‚îÄ‚îÄ Zone rectangles ‚îÄ‚îÄ */
    .zone {
      position: absolute; border: 2px solid; border-radius: 0;
      display: flex; align-items: center; justify-content: center;
      cursor: default; z-index: 1;
    }
    .zone-label {
      font-size: 12px; font-weight: 700; color: rgba(0,0,0,0.55);
      text-align: center; padding: 4px 6px; pointer-events: none;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 100%;
    }

    /* ‚îÄ‚îÄ Isle rectangles ‚îÄ‚îÄ */
    .isle {
      position: absolute; border-width: 3px; border-style: solid;
      display: flex; flex-direction: column; padding: 0; overflow: hidden;
      cursor: default; z-index: 2;
    }

    /* ‚îÄ‚îÄ Selection indicators ‚îÄ‚îÄ */
    .isle.isle-selected { outline: 2px dashed #60a5fa; outline-offset: 3px; z-index: 3; }
    .zone.zone-selected { outline: 2px dashed #f87171; outline-offset: 3px; z-index: 4; }

    /* ‚îÄ‚îÄ Search highlights ‚îÄ‚îÄ */
    .isle.isle-highlight      { background: rgba(254,240,138,0.5) !important; z-index: 10; }
    .subsection.sub-highlight { background: rgba(253,224,71,0.4)  !important; }
    @keyframes pulse-shelf {
      0%   { box-shadow: 0 0 0 0   rgba(251,146,60,0.9); background: rgba(251,146,60,0.55); }
      50%  { box-shadow: 0 0 0 5px rgba(251,146,60,0);   background: rgba(253,186,116,0.8); }
      100% { box-shadow: 0 0 0 0   rgba(251,146,60,0.9); background: rgba(251,146,60,0.55); }
    }
    .shelf-slot.shelf-highlight { animation: pulse-shelf 1s ease-in-out infinite; }
    .zone.zone-highlight { outline: 3px solid rgba(74,222,128,0.9) !important; outline-offset: 3px; z-index: 5; }

    .isle-header {
      padding: 3px 6px; font-size: 11px; font-weight: 700;
      flex-shrink: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }
    .isle-body { flex: 1; display: flex; flex-direction: column; gap: 2px; padding: 2px; overflow: hidden; }
    .subsection {
      flex: 1; border: 1px dashed rgba(0,0,0,0.22);
      display: flex; flex-direction: column; cursor: pointer; border-radius: 2px;
      transition: background 0.12s; overflow: hidden; min-width: 0;
    }
    .subsection:hover { background: rgba(255,255,255,0.55); }
    .sub-number { font-size: 8px; font-weight: 700; color: rgba(0,0,0,0.3); padding: 1px 3px; flex-shrink: 0; line-height: 1; }
    .sub-shelves { flex: 1; display: flex; gap: 1px; padding: 1px 2px 2px; min-height: 0; overflow: hidden; }
    .shelf-slot {
      flex: 1; border: 1px solid rgba(0,0,0,0.2); border-radius: 1px;
      display: flex; align-items: center; justify-content: center;
      font-size: 7px; font-weight: 700; color: rgba(0,0,0,0.5);
      background: rgba(255,255,255,0.5); overflow: hidden; min-width: 0;
    }
    .wall-indicator { width: 5px; background: rgba(0,0,0,0.28); flex-shrink: 0; border-radius: 1px; }

    /* ‚îÄ‚îÄ Draw preview ‚îÄ‚îÄ */
    #draw-preview {
      position: absolute; border: 2px dashed #60a5fa;
      background: rgba(96,165,250,0.07); pointer-events: none; display: none;
    }

    /* ‚îÄ‚îÄ Facing toggle ‚îÄ‚îÄ */
    .facing-group { display: flex; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; }
    .facing-opt {
      flex: 1; padding: 9px 8px; border: none; background: #f8fafc;
      cursor: pointer; font-size: 12px; font-weight: 600; color: #64748b;
      text-align: center; line-height: 1.5; transition: background 0.15s, color 0.15s;
      font-family: inherit;
    }
    .facing-opt + .facing-opt { border-left: 1px solid #e2e8f0; }
    .facing-opt.selected { background: #3b82f6; color: white; }

    /* ‚ïê‚ïê FLOATING SIDE MENU ‚ïê‚ïê */
    .floating-menu {
      position: fixed; right: 16px; top: 50%;
      transform: translateY(-50%);
      transition: transform 0.28s cubic-bezier(0.4, 0, 0.2, 1);
      background: #1e293b; border: 1px solid #334155;
      border-radius: 14px; padding: 16px 13px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.04);
      display: flex; flex-direction: column; gap: 8px; min-width: 148px; z-index: 100;
    }
    .floating-menu.collapsed { transform: translateY(-50%) translateX(calc(100% + 16px)); }

    .menu-toggle-tab {
      position: absolute; left: -26px; top: 50%; transform: translateY(-50%);
      width: 26px; height: 54px;
      background: #1e293b; border: 1px solid #334155; border-right: none;
      border-radius: 10px 0 0 10px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-size: 15px; font-weight: 700; color: #60a5fa;
      box-shadow: -4px 0 14px rgba(0,0,0,0.35); padding: 0; line-height: 1;
      transition: background 0.15s, color 0.15s;
    }
    .menu-toggle-tab:hover { background: #334155; color: #93c5fd; }

    .floating-menu h3 {
      margin: 0 0 4px; font-size: 11px; font-weight: 700; letter-spacing: 0.8px;
      text-transform: uppercase; color: #475569;
      border-bottom: 1px solid #334155; padding-bottom: 8px; text-align: center;
    }
    .floating-menu button {
      padding: 9px 12px; border: none; border-radius: 8px; cursor: pointer;
      font-size: 12px; font-weight: 600; color: white; font-family: inherit;
      transition: filter 0.2s, transform 0.1s; text-align: left;
      display: flex; align-items: center; gap: 7px;
    }
    .floating-menu button:active { transform: scale(0.96); }
    .floating-menu hr { border: none; border-top: 1px solid #334155; margin: 2px 0; }

    .btn-add-isle        { background: linear-gradient(135deg, #3b82f6, #2563eb); }
    .btn-add-isle:hover  { filter: brightness(1.15); }
    .btn-add-isle.active { background: linear-gradient(135deg, #1d4ed8, #1e40af); box-shadow: 0 0 0 2px #60a5fa; }
    .btn-add-zone        { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
    .btn-add-zone:hover  { filter: brightness(1.15); }
    .btn-add-zone.active { background: linear-gradient(135deg, #6d28d9, #5b21b6); box-shadow: 0 0 0 2px #a78bfa; }
    .btn-edit-warehouse        { background: linear-gradient(135deg, #f59e0b, #d97706); }
    .btn-edit-warehouse:hover  { filter: brightness(1.12); }
    .btn-edit-warehouse.active { background: linear-gradient(135deg, #b45309, #92400e); box-shadow: 0 0 0 2px #fbbf24; }
    .btn-save-layout      { background: linear-gradient(135deg, #10b981, #059669); }
    .btn-save-layout:hover{ filter: brightness(1.12); }
    .btn-load-layout      { background: linear-gradient(135deg, #14b8a6, #0d9488); }
    .btn-load-layout:hover{ filter: brightness(1.12); }
    .btn-add-bg           { background: linear-gradient(135deg, #6366f1, #4f46e5); }
    .btn-add-bg:hover     { filter: brightness(1.12); }
    .btn-clear-bg         { background: linear-gradient(135deg, #64748b, #475569); }
    .btn-clear-bg:hover   { filter: brightness(1.12); }

    .status-msg {
      font-size: 10px; color: #64748b; text-align: center;
      min-height: 26px; line-height: 1.5; padding: 2px 0;
    }
    .isle-count {
      font-size: 10px; color: #475569; text-align: center;
      border-top: 1px solid #334155; padding-top: 6px; font-weight: 600;
    }
    .zoom-controls { display: flex; gap: 4px; margin-top: 2px; }
    .zoom-controls button {
      flex: 1; padding: 7px 4px; border: 1px solid #334155; border-radius: 7px;
      background: #0f172a; cursor: pointer; font-size: 16px; font-weight: 700;
      color: #94a3b8; line-height: 1; transition: background 0.15s, color 0.15s;
    }
    .zoom-controls button:hover { background: #1e3a5f; color: #60a5fa; }
    #zoom-display { font-size: 10px; color: #475569; text-align: center; font-weight: 600; }

    /* ‚ïê‚ïê MODALS ‚ïê‚ïê */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6);
      display: flex; align-items: center; justify-content: center; z-index: 500;
      backdrop-filter: blur(4px);
    }
    .modal-overlay.hidden { display: none; }
    .modal {
      background: #ffffff; border-radius: 16px; padding: 28px 28px 22px;
      width: 430px; max-width: 95vw; max-height: 90vh; overflow-y: auto;
      box-shadow: 0 20px 60px rgba(0,0,0,0.4); display: flex; flex-direction: column;
      gap: 14px; position: relative; border: 1px solid #e2e8f0;
    }
    .modal-close {
      position: absolute; top: 14px; right: 16px; background: none; border: none;
      font-size: 18px; line-height: 1; color: #94a3b8; cursor: pointer;
      padding: 4px 7px; border-radius: 6px; transition: background 0.15s, color 0.15s;
    }
    .modal-close:hover { background: #f1f5f9; color: #334155; }
    .modal-title    { font-size: 17px; font-weight: 700; color: #0f172a; margin: 0; padding-right: 30px; }
    .modal-subtitle { font-size: 12px; color: #94a3b8; margin: -8px 0 0; line-height: 1.5; }
    .modal-actions  { display: flex; gap: 10px; justify-content: flex-end; margin-top: 4px; }
    .modal-actions button {
      padding: 9px 22px; border: none; border-radius: 8px;
      font-size: 13px; font-weight: 600; cursor: pointer; font-family: inherit;
      transition: filter 0.15s, transform 0.1s;
    }
    .modal-actions button:active { transform: scale(0.97); }
    .btn-cancel  { background: #f1f5f9; color: #475569; }
    .btn-cancel:hover  { background: #e2e8f0; }
    .btn-confirm { background: #3b82f6; color: white; }
    .btn-confirm:hover { filter: brightness(1.1); }
    .btn-danger  { background: #ef4444; color: white; }
    .btn-danger:hover  { filter: brightness(1.1); }

    /* ‚îÄ‚îÄ Form fields ‚îÄ‚îÄ */
    .form-field { display: flex; flex-direction: column; gap: 5px; }
    .form-field label { font-size: 12px; font-weight: 600; color: #64748b; letter-spacing: 0.2px; }
    .form-field input, .form-field textarea {
      padding: 9px 11px; border: 1px solid #e2e8f0; border-radius: 8px;
      font-size: 13px; outline: none; font-family: inherit; width: 100%;
      background: #f8fafc; color: #0f172a; transition: border-color 0.15s, box-shadow 0.15s;
    }
    .form-field input:focus, .form-field textarea:focus {
      border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.12); background: white;
    }
    .form-field textarea { resize: vertical; min-height: 70px; }
    .two-col { display: flex; gap: 12px; }
    .two-col .form-field { flex: 1; }

    /* ‚îÄ‚îÄ Color pickers ‚îÄ‚îÄ */
    .color-pick-row { display: flex; align-items: center; gap: 10px; }
    .color-pick-row input[type="color"] {
      width: 44px; height: 36px; padding: 2px;
      border: 1px solid #e2e8f0; border-radius: 8px; cursor: pointer; flex-shrink: 0;
    }
    .color-pick-hint { font-size: 11px; color: #94a3b8; }

    /* ‚îÄ‚îÄ Shelf count input ‚îÄ‚îÄ */
    .shelf-count-input {
      width: 100%; padding: 10px 12px; border: 1px solid #e2e8f0; border-radius: 8px;
      font-size: 22px; text-align: center; outline: none; font-family: inherit;
      background: #f8fafc; color: #0f172a;
    }
    .shelf-count-input:focus { border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.12); }
    .shelf-list { display: flex; flex-direction: column; gap: 7px; max-height: 280px; overflow-y: auto; padding-right: 4px; }
    .shelf-row  { display: flex; align-items: center; gap: 10px; }
    .shelf-row .shelf-num { font-size: 12px; color: #94a3b8; min-width: 54px; font-weight: 600; }
    .shelf-row input {
      flex: 1; padding: 7px 10px; border: 1px solid #e2e8f0; border-radius: 7px;
      font-size: 13px; outline: none; font-family: inherit; background: #f8fafc;
      transition: border-color 0.15s;
    }
    .shelf-row input:focus { border-color: #3b82f6; }

    /* ‚îÄ‚îÄ Select lists ‚îÄ‚îÄ */
    .select-list { display: flex; flex-direction: column; gap: 7px; max-height: 300px; overflow-y: auto; }
    .select-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 11px 15px; border: 1px solid #e2e8f0; border-radius: 10px;
      cursor: pointer; transition: background 0.15s, border-color 0.15s; background: #f8fafc;
    }
    .select-row:hover { background: #eff6ff; border-color: #bfdbfe; }
    .select-row .row-name { font-size: 14px; font-weight: 600; color: #1e293b; }
    .select-row .row-meta { font-size: 11px; color: #94a3b8; }

    /* ‚îÄ‚îÄ Shelf action buttons ‚îÄ‚îÄ */
    .action-btn-group { display: flex; gap: 10px; }
    .action-btn {
      flex: 1; padding: 18px 10px; border: 2px solid #e2e8f0; border-radius: 12px;
      background: #f8fafc; cursor: pointer; font-size: 13px; font-weight: 600; color: #475569;
      display: flex; flex-direction: column; align-items: center; gap: 6px;
      transition: border-color 0.15s, background 0.15s, color 0.15s; font-family: inherit;
    }
    .action-btn .action-icon { font-size: 24px; }
    .action-btn.add:hover { border-color: #3b82f6; background: #eff6ff; color: #1d4ed8; }
    .action-btn.rem:hover { border-color: #ef4444; background: #fef2f2; color: #b91c1c; }
    .action-btn.del:hover { border-color: #b91c1c; background: #fef2f2; color: #b91c1c; }
    .action-btn.del       { color: #ef4444; }

    /* ‚îÄ‚îÄ Remove items list ‚îÄ‚îÄ */
    .item-list { display: flex; flex-direction: column; gap: 5px; max-height: 280px; overflow-y: auto; }
    .item-row {
      display: flex; flex-direction: column; gap: 2px; padding: 9px 13px;
      border: 1px solid #e2e8f0; border-radius: 9px; cursor: pointer;
      transition: background 0.12s, border-color 0.12s; user-select: none; background: #f8fafc;
    }
    .item-row:hover { background: #f1f5f9; }
    .item-row.selected { background: #fff7ed; border-color: #fb923c; }
    .item-row .item-id-label { font-size: 13px; font-weight: 700; color: #1e293b; }
    .item-row .item-meta     { font-size: 11px; color: #94a3b8; }
    .no-items-msg { font-size: 13px; color: #cbd5e1; text-align: center; padding: 20px 0; }
    .selected-count { font-size: 12px; color: #94a3b8; text-align: right; font-weight: 500; }

    /* ‚ïê‚ïê MOBILE RESPONSIVE ‚ïê‚ïê */
    @media (max-width: 640px) {
      .app-header { height: auto; padding: 8px 12px; flex-wrap: wrap; gap: 8px; }
      .brand-name { font-size: 20px; order: -1; width: 100%; text-align: center; }
      .search-bar { order: 1; }
      .app-main { padding: 6px 6px; }
      .floating-menu {
        right: 8px; top: auto; bottom: 12px;
        transform: none;
        transition: transform 0.28s cubic-bezier(0.4, 0, 0.2, 1);
        flex-direction: row; flex-wrap: wrap; min-width: unset; max-width: calc(100vw - 30px);
        padding: 10px 10px; gap: 6px; border-radius: 14px;
      }
      .floating-menu.collapsed { transform: translateY(calc(100% + 12px)); }
      .menu-toggle-tab {
        left: auto; top: auto; right: 8px; bottom: calc(100% + 12px);
        transform: none; width: 48px; height: 28px;
        border-radius: 8px 8px 0 0; border-right: 1px solid #334155; border-bottom: none;
        font-size: 12px;
      }
      .floating-menu h3 { width: 100%; margin: 0; }
      .floating-menu button { font-size: 11px; padding: 7px 9px; }
      .status-msg, .isle-count, #zoom-display { display: none; }
      .zoom-controls { display: none; }
    }
    @media (max-width: 900px) and (min-width: 641px) {
      .floating-menu { right: 10px; }
      .app-main { padding: 8px 10px; }
    }
  </style>
</head>
<body>

  <!-- ‚îÄ‚îÄ App Header: search + brand ‚îÄ‚îÄ -->
  <header class="app-header">
    <div class="search-bar">
      <div class="search-input-wrap">
        <input type="text" id="search-input" placeholder="Search by Item ID..." autocomplete="off"
               oninput="onSearchInput()" onkeydown="if(event.key==='Enter') runSearch()" />
        <button class="btn-search" onclick="runSearch()">Search</button>
        <button class="btn-clear-search" id="btn-clear" onclick="clearSearch()" style="display:none">Clear</button>
      </div>
      <div class="search-results hidden" id="search-results"></div>
    </div>
    <div class="brand-name">IndSurp</div>
  </header>

  <!-- ‚îÄ‚îÄ Main content ‚îÄ‚îÄ -->
  <main class="app-main">
  <div class="warehouse-panel" id="warehouse-panel">
    <div id="tab-bar" class="tab-bar"></div>
    <div class="viewport" id="viewport">
      <div class="pan-zoom-layer" id="pan-zoom-layer">
        <div class="warehouse-wrapper" id="warehouse-wrapper">
          <div class="warehouse" id="warehouse">
            <div id="draw-preview"></div>
          </div>
          <div class="rh rh-nw" data-edge="nw"></div>
          <div class="rh rh-n"  data-edge="n"></div>
          <div class="rh rh-ne" data-edge="ne"></div>
          <div class="rh rh-e"  data-edge="e"></div>
          <div class="rh rh-se" data-edge="se"></div>
          <div class="rh rh-s"  data-edge="s"></div>
          <div class="rh rh-sw" data-edge="sw"></div>
          <div class="rh rh-w"  data-edge="w"></div>
        </div>
      </div>
    </div>
  </div>
  </main>

  <div class="floating-menu" id="floating-menu">
    <button class="menu-toggle-tab" id="menu-toggle-tab" onclick="toggleMenu()" title="Toggle menu">&#x203A;</button>
    <h3>Warehouse Tools</h3>
    <button class="btn-add-isle" id="btn-add-isle" onclick="activateDrawMode()">Add Isle</button>
    <button class="btn-add-zone" id="btn-add-zone" onclick="activateZoneMode()">Add Zone</button>
    <button class="btn-edit-warehouse" id="btn-edit-warehouse" onclick="activateEditMode()">Edit Warehouse</button>
    <hr style="border:none;border-top:1px solid #eee;margin:4px 0;">
    <button class="btn-save-layout" onclick="exportLayout()">Save Layout</button>
    <button class="btn-load-layout" onclick="triggerImport()">Load Layout</button>
    <button class="btn-add-bg" onclick="triggerBgImport()">Add Background</button>
    <button class="btn-clear-bg" id="btn-clear-bg" onclick="clearBackground()" style="display:none">Clear Background</button>
    <input type="file" id="import-file-input" accept=".json" style="display:none" onchange="handleImportFile(this)">
    <input type="file" id="bg-file-input" accept="image/png,image/jpeg" style="display:none" onchange="handleBgFile(this)">
    <div class="status-msg" id="status">Click "Add Isle" then<br>draw inside the warehouse.</div>
    <div class="isle-count" id="isle-count">Isles: 0</div>
    <div style="display:flex;gap:5px;margin-top:2px;">
      <button onclick="zoomOut()" title="Zoom Out" style="flex:1;padding:7px 4px;border:1px solid #ddd;border-radius:6px;background:#f5f5f5;cursor:pointer;font-size:18px;font-weight:700;color:#555;line-height:1;">‚àí</button>
      <button onclick="resetView()" title="Reset View" style="flex:1;padding:7px 4px;border:1px solid #ddd;border-radius:6px;background:#f5f5f5;cursor:pointer;font-size:13px;font-weight:700;color:#555;line-height:1;">‚åÇ</button>
      <button onclick="zoomIn()" title="Zoom In" style="flex:1;padding:7px 4px;border:1px solid #ddd;border-radius:6px;background:#f5f5f5;cursor:pointer;font-size:18px;font-weight:700;color:#555;line-height:1;">+</button>
    </div>
    <div id="zoom-display" style="font-size:11px;color:#aaa;text-align:center;">100%</div>
  </div>

  <!-- ‚ïê‚ïê CREATION STEP 1: Isle name + shelves per subsection ‚ïê‚ïê -->
  <div class="modal-overlay hidden" id="modal-count">
    <div class="modal">
      <button class="modal-close" onclick="cancelIsleCreation()" title="Close">&#x2715;</button>
      <p class="modal-title">New Isle</p>
      <p class="modal-subtitle">Name this isle and set how many shelves each subsection will have.</p>
      <div class="form-field">
        <label>Isle Name <span style="color:#e53935">*</span></label>
        <input type="text" id="isle-name-input" placeholder="e.g. Aisle 1, Electronics Row" />
      </div>
      <div class="form-field">
        <label>Shelves per Subsection <span style="color:#888;font-weight:400">(max 26)</span></label>
        <input class="shelf-count-input" id="shelf-count-input" type="number" min="1" max="26" value="1" />
      </div>
      <div class="two-col">
        <div class="form-field">
          <label>Isle Border Color</label>
          <div class="color-pick-row">
            <input type="color" id="isle-color-input" oninput="onIsleColorChange(this.value)" />
            <span class="color-pick-hint">Isle border</span>
          </div>
        </div>
        <div class="form-field">
          <label>Isle Name Color</label>
          <div class="color-pick-row">
            <input type="color" id="isle-label-color-input" oninput="onIsleLabelColorChange(this.value)" />
            <span class="color-pick-hint">Name label</span>
          </div>
        </div>
      </div>
      <div class="two-col">
        <div class="form-field">
          <label>Shelf Border Color</label>
          <div class="color-pick-row">
            <input type="color" id="shelf-color-input" value="#aaaaaa" />
            <span class="color-pick-hint">Shelf slot borders</span>
          </div>
        </div>
        <div class="form-field">
          <label>Isle Fill Color</label>
          <div class="color-pick-row">
            <input type="color" id="isle-fill-color" value="#ffffff" oninput="onIsleFillChange()" />
            <span class="color-pick-hint">Inner fill</span>
          </div>
        </div>
      </div>
      <div class="form-field">
        <label>Isle Fill Opacity <span id="isle-fill-opacity-label" style="font-weight:400;color:#888;">0%</span></label>
        <input type="range" id="isle-fill-opacity" min="0" max="100" value="0" oninput="onIsleFillChange()" style="width:100%;margin-top:4px;">
      </div>
      <div class="form-field">
        <label>Isle Facing</label>
        <div class="facing-group">
          <button type="button" class="facing-opt selected" data-value="right" onclick="setFacing('right')">‚Üê Right-facing<br><span style="font-size:10px;font-weight:400;">First shelf on left</span></button>
          <button type="button" class="facing-opt" data-value="left" onclick="setFacing('left')">Left-facing ‚Üí<br><span style="font-size:10px;font-weight:400;">First shelf on right</span></button>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="cancelIsleCreation()">Cancel</button>
        <button class="btn-confirm" onclick="confirmStep1()">Next ‚Üí</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê CREATION STEP 2: Subsection config ‚ïê‚ïê -->
  <div class="modal-overlay hidden" id="modal-subsections">
    <div class="modal">
      <button class="modal-close" onclick="cancelIsleCreation()" title="Close">&#x2715;</button>
      <p class="modal-title" id="subsection-config-title">Subsection Setup</p>
      <p class="modal-subtitle">Set how many subsections and where the numbering starts.</p>
      <div class="two-col">
        <div class="form-field">
          <label>Start Number</label>
          <input type="number" id="subsection-start-input" min="1" value="1" />
        </div>
        <div class="form-field">
          <label>Number of Subsections</label>
          <input type="number" id="subsection-count-input" min="1" value="1" />
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="goBackToStep1()">‚Üê Back</button>
        <button class="btn-confirm" onclick="confirmStep2()">Next ‚Üí</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê CREATION STEP 3: Label shelves ‚ïê‚ïê -->
  <div class="modal-overlay hidden" id="modal-labels">
    <div class="modal">
      <button class="modal-close" onclick="cancelIsleCreation()" title="Close">&#x2715;</button>
      <p class="modal-title" id="modal-labels-title">Label Shelves</p>
      <p class="modal-subtitle">These labels apply to every subsection in the isle.</p>
      <div class="shelf-list" id="shelf-list"></div>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="goBackToStep2()">‚Üê Back</button>
        <button class="btn-confirm" onclick="confirmStep3()">Confirm</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê INTERACTION: Select subsection ‚ïê‚ïê -->
  <div class="modal-overlay hidden" id="modal-subsection-select">
    <div class="modal">
      <button class="modal-close" onclick="closeAllModals()" title="Close">&#x2715;</button>
      <p class="modal-title" id="subsection-select-title">Select a Subsection</p>
      <p class="modal-subtitle">Click a subsection to manage its shelves.</p>
      <div class="select-list" id="subsection-select-list"></div>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeAllModals()">Close</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê INTERACTION: Select shelf ‚ïê‚ïê -->
  <div class="modal-overlay hidden" id="modal-shelf-select">
    <div class="modal">
      <button class="modal-close" onclick="closeAllModals()" title="Close">&#x2715;</button>
      <p class="modal-title" id="shelf-select-title">Select a Shelf</p>
      <p class="modal-subtitle">Click a shelf to manage its items.</p>
      <div class="select-list" id="shelf-select-list"></div>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="backToSubsectionSelect()">‚Üê Back</button>
        <button class="btn-confirm" onclick="openAddShelf()">+ Add Shelf</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê INTERACTION: Add shelf ‚ïê‚ïê -->
  <div class="modal-overlay hidden" id="modal-add-shelf">
    <div class="modal">
      <button class="modal-close" onclick="closeAllModals()" title="Close">&#x2715;</button>
      <p class="modal-title">Add Shelf</p>
      <p class="modal-subtitle" id="add-shelf-subtitle"></p>
      <div class="form-field">
        <label>Shelf Name <span style="color:#e53935">*</span></label>
        <input type="text" id="add-shelf-name-input" placeholder="e.g. D" />
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="backToShelfSelectFromAdd()">‚Üê Back</button>
        <button class="btn-confirm" onclick="confirmAddShelf()">Add Shelf</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê INTERACTION: Shelf actions ‚ïê‚ïê -->
  <div class="modal-overlay hidden" id="modal-shelf-actions">
    <div class="modal">
      <button class="modal-close" onclick="closeAllModals()" title="Close">&#x2715;</button>
      <p class="modal-title" id="shelf-actions-title">Shelf Actions</p>
      <p class="modal-subtitle" id="shelf-actions-subtitle"></p>
      <div class="action-btn-group">
        <button class="action-btn add" onclick="openAddItem()">
          <span class="action-icon">Ôºã</span>Add Item
        </button>
        <button class="action-btn rem" onclick="openRemoveItems()">
          <span class="action-icon">Ôºç</span>Remove Item
        </button>
        <button class="action-btn del" onclick="deleteShelf()">
          <span class="action-icon">üóë</span>Delete Shelf
        </button>
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="backToShelfSelect()">‚Üê Back</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê INTERACTION: Add item ‚ïê‚ïê -->
  <div class="modal-overlay hidden" id="modal-add-item">
    <div class="modal">
      <button class="modal-close" onclick="closeAllModals()" title="Close">&#x2715;</button>
      <p class="modal-title">Add Item</p>
      <p class="modal-subtitle" id="add-item-subtitle"></p>
      <div class="form-field">
        <label>Item ID <span style="color:#e53935">*</span></label>
        <input type="text" id="item-id-input" placeholder="e.g. SKU-00123" />
      </div>
      <div class="form-field">
        <label>Item Type</label>
        <input type="text" id="item-type-input" placeholder="e.g. Electronics" />
      </div>
      <div class="form-field">
        <label>Item Category</label>
        <input type="text" id="item-category-input" placeholder="e.g. Accessories" />
      </div>
      <div class="form-field">
        <label>Notes</label>
        <textarea id="item-notes-input" placeholder="Any additional notes..."></textarea>
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="backFromAddItem()">‚Üê Back</button>
        <button class="btn-confirm" onclick="confirmAddItem()">Add Item</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê ZONE: Label modal ‚ïê‚ïê -->
  <div class="modal-overlay hidden" id="modal-zone">
    <div class="modal">
      <button class="modal-close" onclick="cancelZoneCreation()" title="Close">&#x2715;</button>
      <p class="modal-title">New Zone</p>
      <p class="modal-subtitle">Label this area of the warehouse.</p>
      <div class="form-field">
        <label>Zone Label <span style="color:#e53935">*</span></label>
        <input type="text" id="zone-label-input" placeholder="e.g. Receiving, Break Room, Staging" />
      </div>
      <div class="two-col">
        <div class="form-field">
          <label>Zone Border Color</label>
          <div class="color-pick-row">
            <input type="color" id="zone-color-input" oninput="onZoneColorChange(this.value)" />
            <span class="color-pick-hint">Border &amp; fill</span>
          </div>
        </div>
        <div class="form-field">
          <label>Zone Name Color</label>
          <div class="color-pick-row">
            <input type="color" id="zone-name-color-input" value="#444444" oninput="onZoneNameColorChange(this.value)" />
            <span class="color-pick-hint">Label text</span>
          </div>
        </div>
      </div>
      <div class="form-field">
        <label>Fill Opacity <span id="zone-fill-opacity-label" style="font-weight:400;color:#888;">18%</span></label>
        <input type="range" id="zone-fill-opacity" min="0" max="100" value="18" oninput="onZoneFillOpacityChange()" style="width:100%;margin-top:4px;">
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="cancelZoneCreation()">Cancel</button>
        <button class="btn-confirm" onclick="confirmZone()">Create Zone</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê INTERACTION: Confirm delete shelf ‚ïê‚ïê -->
  <div class="modal-overlay hidden" id="modal-confirm-delete">
    <div class="modal">
      <p class="modal-title">Delete Shelf?</p>
      <p class="modal-subtitle" id="confirm-delete-msg"></p>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="hide('modal-confirm-delete')">No, Keep It</button>
        <button class="btn-danger" onclick="confirmDeleteShelf()">Yes, Delete</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê COPY/PASTE: Paste isle name ‚ïê‚ïê -->
  <div class="modal-overlay hidden" id="modal-paste-isle">
    <div class="modal">
      <button class="modal-close" onclick="cancelPaste()" title="Close">&#x2715;</button>
      <p class="modal-title">Paste Isle</p>
      <p class="modal-subtitle" id="paste-isle-subtitle">All settings and structure will be copied. Items will not be copied.</p>
      <div class="form-field">
        <label>New Isle Name <span style="color:#e53935">*</span></label>
        <input type="text" id="paste-isle-name" placeholder="Enter a name for the pasted isle" />
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="cancelPaste()">Cancel</button>
        <button class="btn-confirm" onclick="pasteIsle()">Paste</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê EDIT MODE: Delete isle / zone ‚ïê‚ïê -->
  <div class="modal-overlay hidden" id="modal-delete-entity">
    <div class="modal">
      <p class="modal-title" id="delete-entity-title">Delete?</p>
      <p class="modal-subtitle" id="delete-entity-msg"></p>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="hide('modal-delete-entity')">Cancel</button>
        <button class="btn-danger" onclick="confirmDeleteEntity()">Yes, Delete</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê CONFIRM: Load layout ‚ïê‚ïê -->
  <div class="modal-overlay hidden" id="modal-confirm-import">
    <div class="modal">
      <p class="modal-title">Load Layout?</p>
      <p class="modal-subtitle">This will replace all warehouse tabs with the loaded layout. All unsaved changes will be lost.</p>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="hide('modal-confirm-import')">Cancel</button>
        <button class="btn-danger" onclick="confirmImport()">Yes, Load</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê INTERACTION: Remove items ‚ïê‚ïê -->
  <div class="modal-overlay hidden" id="modal-remove-items">
    <div class="modal">
      <button class="modal-close" onclick="closeAllModals()" title="Close">&#x2715;</button>
      <p class="modal-title" id="remove-items-title">Remove Items</p>
      <p class="modal-subtitle">Click to select ¬∑ Ctrl+Click for multiple</p>
      <div class="item-list" id="item-list"></div>
      <div class="selected-count" id="selected-count">0 selected</div>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="backToShelfActions()">‚Üê Back</button>
        <button class="btn-danger" id="btn-remove-confirm" onclick="confirmRemoveItems()">Remove Selected</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê ZONE: Item actions modal ‚ïê‚ïê -->
  <div class="modal-overlay hidden" id="modal-zone-actions">
    <div class="modal">
      <button class="modal-close" onclick="closeAllModals()" title="Close">&#x2715;</button>
      <p class="modal-title" id="zone-actions-title">Zone</p>
      <p class="modal-subtitle" id="zone-actions-subtitle"></p>
      <div class="action-btn-group">
        <button class="action-btn add" onclick="openAddZoneItem()">
          <span class="action-icon">Ôºã</span>Add Item
        </button>
        <button class="action-btn rem" onclick="openZoneItemList()">
          <span class="action-icon">&#x2261;</span>Manage Items
        </button>
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="closeAllModals()">Close</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê ZONE: Manage items modal ‚ïê‚ïê -->
  <div class="modal-overlay hidden" id="modal-zone-items">
    <div class="modal">
      <button class="modal-close" onclick="closeAllModals()" title="Close">&#x2715;</button>
      <p class="modal-title" id="zone-items-title">Zone Items</p>
      <p class="modal-subtitle">Click to select ¬∑ Ctrl+Click for multiple</p>
      <div class="item-list" id="zone-item-list"></div>
      <div class="selected-count" id="zone-selected-count">0 selected</div>
      <div class="modal-actions">
        <button class="btn-cancel" onclick="backToZoneActions()">‚Üê Back</button>
        <button class="btn-danger" id="btn-zone-remove-confirm" onclick="confirmRemoveZoneItems()">Remove Selected</button>
      </div>
    </div>
  </div>

  <script>
    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       STATE
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    const isles = [];
    let isleCounter       = 0;
    let subsectionCounter = 0;
    let shelfCounter      = 0;
    let itemCounter       = 0;

    const zones = [];
    let zoneCounter = 0;
    let pendingZone = null;
    let activeZoneForItems = null;
    let selectedZoneItemIds = new Set();

    // Zone drag state
    let isDraggingZone = false, draggingZone = null, zoneDragMoved = false;
    let zoneStartMX = 0, zoneStartMY = 0, zoneStartX = 0, zoneStartY = 0;

    // Entity (isle/zone) resize state
    let isEntityResizing = false;
    let entityResizeTarget = null, entityResizeTargetType = null, entityResizeEdge = null;
    let entityResizeStartMX = 0, entityResizeStartMY = 0;
    let entityResizeStartX  = 0, entityResizeStartY  = 0;
    let entityResizeStartW  = 0, entityResizeStartH  = 0;

    // Entity (isle/zone) rotation state
    let isRotating = false;
    let rotatingEntity = null, rotatingEntityType = null;
    let rotateStartAngle = 0;
    let rotateCenterX = 0, rotateCenterY = 0;
    let rotateStartMouseAngle = 0;

    let currentZoom = 1;
    let panX = 0, panY = 0;
    let isPanning = false, panLastX = 0, panLastY = 0;

    let editMode = false;

    // Warehouse resize state
    let isResizing = false, resizeEdge = null;
    let resizeStartMX = 0, resizeStartMY = 0;
    let resizeStartW  = 0, resizeStartH  = 0;
    let resizeStartPanX = 0, resizeStartPanY = 0;

    // Isle drag state
    let isDraggingIsle = false, draggingIsle = null;
    let isleStartMX = 0, isleStartMY = 0;
    let isleStartX  = 0, isleStartY  = 0;
    let isleDragMoved = false;

    let drawMode  = null;
    let isDrawing = false;
    let startX = 0, startY = 0;

    // Copy/paste state
    let selectedIsle = null; // isle highlighted in edit mode for Ctrl+C / delete
    let copiedIsle   = null; // serialized snapshot of the last Ctrl+C'd isle
    let selectedZone = null; // zone highlighted in edit mode for delete

    // Multi-warehouse state
    const warehouses = [];
    let activeWarehouseIdx = 0;
    let warehouseTabCounter = 0;

    let pendingFacing    = 'right'; // 'left' | 'right'
    let pendingIsle      = null;   // isle being constructed through the 3-step modal flow
    let activeIsle       = null;
    let activeSubsection = null;
    let activeShelf      = null;
    let selectedItemIds  = new Set();

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       DOM
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    const viewport        = document.getElementById('viewport');
    const panZoomLayer    = document.getElementById('pan-zoom-layer');
    const warehouseWrapper = document.getElementById('warehouse-wrapper');
    const warehouse       = document.getElementById('warehouse');
    const preview   = document.getElementById('draw-preview');
    const statusEl  = document.getElementById('status');
    const countEl   = document.getElementById('isle-count');

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       UTILITIES
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    function randomColor() { return `hsl(${Math.floor(Math.random()*360)},70%,42%)`; }
    function randomHexColor() {
      return '#' + Math.floor(Math.random()*0xFFFFFF).toString(16).padStart(6,'0');
    }
    function hexToRgba(hex, alpha) {
      const r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16);
      return `rgba(${r},${g},${b},${alpha})`;
    }
    function randomZoneColors() {
      const h = Math.floor(Math.random()*360);
      return { bg: `hsla(${h},60%,72%,0.22)`, border: `hsl(${h},55%,42%)` };
    }
    function applyIsleFill(el, fillColor, fillOpacity) {
      el.style.background = fillOpacity > 0 ? hexToRgba(fillColor, fillOpacity / 100) : 'transparent';
    }
    function applyZoneFill(el, borderColor, fillOpacity) {
      el.style.background = hexToRgba(borderColor, fillOpacity / 100);
    }

    function triggerBgImport() { document.getElementById('bg-file-input').click(); }
    function handleBgFile(input) {
      const file = input.files[0];
      if (!file) return;
      input.value = '';
      const reader = new FileReader();
      reader.onload = (ev) => setWarehouseBackground(ev.target.result);
      reader.readAsDataURL(file);
    }

    function onIsleColorChange(v) {
      if (!pendingIsle) return;
      pendingIsle.color = v;
      pendingIsle.element.style.borderColor = v;
    }
    function onIsleLabelColorChange(v) {
      if (!pendingIsle) return;
      pendingIsle.labelColor = v;
      const lbl = pendingIsle.element.querySelector('.isle-label');
      if (lbl) lbl.style.color = v;
    }
    function onIsleFillChange() {
      if (!pendingIsle) return;
      const color   = document.getElementById('isle-fill-color').value;
      const opacity = parseInt(document.getElementById('isle-fill-opacity').value, 10);
      document.getElementById('isle-fill-opacity-label').textContent = opacity + '%';
      pendingIsle.fillColor   = color;
      pendingIsle.fillOpacity = opacity;
      applyIsleFill(pendingIsle.element, color, opacity);
    }
    function onZoneColorChange(v) {
      if (!pendingZone) return;
      pendingZone.color = v;
      pendingZone.element.style.borderColor = v;
      const opacity = parseInt(document.getElementById('zone-fill-opacity').value, 10);
      applyZoneFill(pendingZone.element, v, opacity);
    }
    function onZoneNameColorChange(v) {
      if (!pendingZone) return;
      pendingZone.labelColor = v;
      const lbl = pendingZone.element.querySelector('.zone-label');
      if (lbl) lbl.style.color = v;
    }
    function onZoneFillOpacityChange() {
      if (!pendingZone) return;
      const opacity = parseInt(document.getElementById('zone-fill-opacity').value, 10);
      document.getElementById('zone-fill-opacity-label').textContent = opacity + '%';
      pendingZone.fillOpacity = opacity;
      applyZoneFill(pendingZone.element, pendingZone.color, opacity);
    }
    function clamp(v,lo,hi) { return Math.max(lo,Math.min(hi,v)); }
    function getRelativePos(e) {
      const r  = warehouse.getBoundingClientRect();
      const bx = parseFloat(getComputedStyle(warehouse).borderLeftWidth)||0;
      const by = parseFloat(getComputedStyle(warehouse).borderTopWidth) ||0;
      // Divide by currentZoom to convert from viewport px to logical (CSS) px
      const lx = (e.clientX - r.left) / currentZoom - bx;
      const ly = (e.clientY - r.top ) / currentZoom - by;
      return { x: clamp(lx, 0, warehouse.clientWidth),
               y: clamp(ly, 0, warehouse.clientHeight) };
    }
    function show(id) { document.getElementById(id).classList.remove('hidden'); }
    function hide(id) { document.getElementById(id).classList.add('hidden'); }
    function escHtml(s) {
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }
    function closeAllModals() {
      ['modal-count','modal-subsections','modal-labels',
       'modal-subsection-select','modal-shelf-select','modal-add-shelf',
       'modal-shelf-actions','modal-add-item','modal-remove-items',
       'modal-confirm-delete','modal-zone','modal-confirm-import',
       'modal-paste-isle','modal-delete-entity',
       'modal-zone-actions','modal-zone-items'].forEach(hide);
      activeIsle=null; activeSubsection=null; activeShelf=null;
      activeZoneForItems=null;
      selectedItemIds.clear(); selectedZoneItemIds.clear();
    }

    function toggleMenu() {
      const menu = document.getElementById('floating-menu');
      const tab  = document.getElementById('menu-toggle-tab');
      const collapsed = menu.classList.toggle('collapsed');
      // ‚Äπ = expand (menu is hidden, pull it back), ‚Ä∫ = collapse (menu is open, fold it away)
      tab.innerHTML = collapsed ? '&#x2039;' : '&#x203A;';
    }

    function setFacing(v) {
      pendingFacing = v;
      document.querySelectorAll('.facing-opt').forEach(b =>
        b.classList.toggle('selected', b.dataset.value === v));
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       SNAP HELPER
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    const SNAP_THRESHOLD = 12;

    function snapPoint(x, y) {
      if (isles.length === 0 && zones.length === 0) return { x, y };
      const vEdges = [], hEdges = [];
      for (const isle of isles) {
        vEdges.push(isle.position.x, isle.position.x + isle.dimensions.width);
        hEdges.push(isle.position.y, isle.position.y + isle.dimensions.height);
      }
      for (const zone of zones) {
        vEdges.push(zone.position.x, zone.position.x + zone.dimensions.width);
        hEdges.push(zone.position.y, zone.position.y + zone.dimensions.height);
      }
      let snapX = x, bestDX = SNAP_THRESHOLD + 1;
      for (const ex of vEdges) { const d = Math.abs(x - ex); if (d < bestDX) { bestDX = d; snapX = ex; } }
      let snapY = y, bestDY = SNAP_THRESHOLD + 1;
      for (const ey of hEdges) { const d = Math.abs(y - ey); if (d < bestDY) { bestDY = d; snapY = ey; } }
      return { x: snapX, y: snapY };
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       ZONES
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    function snapZoneMove(zone, newX, newY) {
      const w = zone.dimensions.width, h = zone.dimensions.height;
      const vEdges = [0, warehouse.clientWidth], hEdges = [0, warehouse.clientHeight];
      for (const z of zones) {
        if (z.id === zone.id) continue;
        vEdges.push(z.position.x, z.position.x + z.dimensions.width);
        hEdges.push(z.position.y, z.position.y + z.dimensions.height);
      }
      for (const isle of isles) {
        vEdges.push(isle.position.x, isle.position.x + isle.dimensions.width);
        hEdges.push(isle.position.y, isle.position.y + isle.dimensions.height);
      }
      let bestX = newX, bestDX = SNAP_THRESHOLD + 1;
      for (const ve of vEdges) {
        const dl = Math.abs(newX - ve), dr = Math.abs(newX + w - ve);
        if (dl < bestDX) { bestDX = dl; bestX = ve; }
        if (dr < bestDX) { bestDX = dr; bestX = ve - w; }
      }
      let bestY = newY, bestDY = SNAP_THRESHOLD + 1;
      for (const he of hEdges) {
        const dt = Math.abs(newY - he), db = Math.abs(newY + h - he);
        if (dt < bestDY) { bestDY = dt; bestY = he; }
        if (db < bestDY) { bestDY = db; bestY = he - h; }
      }
      return { x: bestX, y: bestY };
    }

    function beginZoneCreation(x, y, w, h) {
      const color = randomHexColor();
      const id = ++zoneCounter;
      const el = document.createElement('div');
      el.className = 'zone';
      Object.assign(el.style, {
        left: `${x}px`, top: `${y}px`, width: `${w}px`, height: `${h}px`,
        borderColor: color, background: hexToRgba(color, 0.18),
      });
      el.dataset.zoneId = id;
      const labelEl = document.createElement('div');
      labelEl.className = 'zone-label';
      labelEl.textContent = '‚Ä¶';
      el.appendChild(labelEl);
      warehouse.appendChild(el);
      pendingZone = { id, label:'', color, fillOpacity:18, labelColor:'#444444', rotation:0,
                      position:{x,y}, dimensions:{width:w,height:h},
                      items:[], element:el, createdAt:new Date().toISOString() };
      document.getElementById('zone-label-input').value = '';
      document.getElementById('zone-label-input').style.borderColor = '';
      document.getElementById('zone-color-input').value = color;
      document.getElementById('zone-name-color-input').value = '#444444';
      document.getElementById('zone-fill-opacity').value = 18;
      document.getElementById('zone-fill-opacity-label').textContent = '18%';
      show('modal-zone');
      document.getElementById('zone-label-input').focus();
    }

    function confirmZone() {
      const inp = document.getElementById('zone-label-input');
      const label = inp.value.trim();
      if (!label) { inp.style.borderColor = '#e53935'; inp.focus(); return; }
      inp.style.borderColor = '';
      const color      = document.getElementById('zone-color-input').value;
      const fillOpacity = parseInt(document.getElementById('zone-fill-opacity').value, 10);
      const labelColor  = document.getElementById('zone-name-color-input').value || '#444444';
      pendingZone.label       = label;
      pendingZone.color       = color;
      pendingZone.fillOpacity = fillOpacity;
      pendingZone.labelColor  = labelColor;
      pendingZone.element.style.borderColor = color;
      applyZoneFill(pendingZone.element, color, fillOpacity);
      const zoneLblEl = pendingZone.element.querySelector('.zone-label');
      zoneLblEl.textContent = label;
      zoneLblEl.style.color = labelColor;
      zones.push(pendingZone);
      attachZoneHandlers(pendingZone);
      statusEl.textContent = `Zone "${label}" added.`;
      pendingZone = null;
      hide('modal-zone');
    }

    function cancelZoneCreation() {
      if (pendingZone) { pendingZone.element.remove(); pendingZone = null; zoneCounter--; }
      hide('modal-zone');
    }

    function attachZoneHandlers(zone) {
      zone.element.addEventListener('mousedown', (e) => {
        if (e.button !== 0) return;
        if (!editMode) return;
        e.stopPropagation(); e.preventDefault();
        selectZone(zone);
        selectIsle(null);
        isDraggingZone = true;
        draggingZone   = zone;
        zoneDragMoved  = false;
        zoneStartMX    = e.clientX;
        zoneStartMY    = e.clientY;
        zoneStartX     = zone.position.x;
        zoneStartY     = zone.position.y;
      });
      zone.element.addEventListener('click', (e) => {
        if (editMode) return;
        e.stopPropagation();
        openZoneActions(zone);
      });
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       PAN / ZOOM
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    function applyTransform() {
      panZoomLayer.style.transform = `translate(${panX}px,${panY}px) scale(${currentZoom})`;
    }
    function updateZoomDisplay() {
      document.getElementById('zoom-display').textContent = `${Math.round(currentZoom * 100)}%`;
    }
    function zoomAt(factor, cx, cy) {
      const nz = Math.min(Math.max(currentZoom * factor, 0.02), 50);
      panX = cx - (cx - panX) * (nz / currentZoom);
      panY = cy - (cy - panY) * (nz / currentZoom);
      currentZoom = nz;
      applyTransform(); updateZoomDisplay();
    }
    function zoomIn()  { const vr=viewport.getBoundingClientRect(); zoomAt(1.25, vr.width/2, vr.height/2); }
    function zoomOut() { const vr=viewport.getBoundingClientRect(); zoomAt(1/1.25, vr.width/2, vr.height/2); }
    function resetView() {
      currentZoom = 1;
      const vr = viewport.getBoundingClientRect();
      panX = (vr.width  - warehouse.offsetWidth)  / 2;
      panY = (vr.height - warehouse.offsetHeight) / 2;
      applyTransform(); updateZoomDisplay();
    }
    window.addEventListener('load', () => {
      warehouseTabCounter = 1;
      warehouses.push({
        id: 1, name: 'Warehouse 1',
        width: 800, height: 500, background: null,
        counters: { isleCounter: 0, subsectionCounter: 0, shelfCounter: 0, itemCounter: 0, zoneCounter: 0 },
        isles: [], zones: [],
      });
      renderTabs();
      resetView();
    });

    // Scroll-wheel zoom centred on cursor
    viewport.addEventListener('wheel', (e) => {
      e.preventDefault();
      const vr = viewport.getBoundingClientRect();
      zoomAt(e.deltaY < 0 ? 1.1 : 1/1.1, e.clientX - vr.left, e.clientY - vr.top);
    }, { passive: false });

    // Middle-mouse pan
    viewport.addEventListener('mousedown', (e) => {
      if (e.button === 1) {
        isPanning = true; panLastX = e.clientX; panLastY = e.clientY;
        viewport.classList.add('panning'); e.preventDefault();
      }
    });

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       EDIT WAREHOUSE MODE
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    const HANDLE_EDGES = ['nw','n','ne','e','se','s','sw','w'];

    function edgePositions(x, y, w, h, rotation) {
      const cx = x + w / 2, cy = y + h / 2;
      const angle = ((rotation || 0) * Math.PI) / 180;
      const cos = Math.cos(angle), sin = Math.sin(angle);
      function rp(lx, ly) {
        return { cx: cx + lx * cos - ly * sin, cy: cy + lx * sin + ly * cos };
      }
      return {
        nw: rp(-w/2, -h/2),  n: rp(0,    -h/2),  ne: rp(w/2,  -h/2),
        e:  rp(w/2,  0),     se: rp(w/2,  h/2),  s:  rp(0,     h/2),
        sw: rp(-w/2, h/2),   w:  rp(-w/2, 0),
        rotate: rp(0, -(h / 2 + 25)),
      };
    }

    function createHandlesForEntity(entity, type) {
      const pos = edgePositions(entity.position.x, entity.position.y,
                                entity.dimensions.width, entity.dimensions.height,
                                entity.rotation || 0);
      for (const edge of [...HANDLE_EDGES, 'rotate']) {
        const el = document.createElement('div');
        el.className    = 'edit-handle';
        el.dataset.edge = edge;
        el.dataset.type = type;
        el.dataset.id   = entity.id;
        el.style.left   = pos[edge].cx + 'px';
        el.style.top    = pos[edge].cy + 'px';
        warehouse.appendChild(el);
      }
    }

    function updateHandlesForEntity(entity, type) {
      const pos = edgePositions(entity.position.x, entity.position.y,
                                entity.dimensions.width, entity.dimensions.height,
                                entity.rotation || 0);
      document.querySelectorAll(`.edit-handle[data-type="${type}"][data-id="${entity.id}"]`)
        .forEach(el => {
          const p = pos[el.dataset.edge];
          if (p) { el.style.left = p.cx + 'px'; el.style.top = p.cy + 'px'; }
        });
    }

    function createEditHandles() {
      removeEditHandles();
      isles.forEach(e => createHandlesForEntity(e, 'isle'));
      zones.forEach(e => createHandlesForEntity(e, 'zone'));
    }

    function removeEditHandles() {
      document.querySelectorAll('.edit-handle').forEach(el => el.remove());
    }

    function activateEditMode() {
      if (editMode) { cancelEditMode(); return; }
      if (drawMode) cancelDrawMode();
      editMode = true;
      warehouseWrapper.classList.add('edit-mode');
      document.getElementById('btn-edit-warehouse').classList.add('active');
      statusEl.innerHTML = 'Drag to move ¬∑ Blue handles to resize ¬∑ Click to select ¬∑ Del to delete.';
      createEditHandles();
    }
    function cancelEditMode() {
      editMode = false;
      isEntityResizing = false; entityResizeTarget = null;
      isleDragMoved = false;
      selectIsle(null);
      selectZone(null);
      warehouseWrapper.classList.remove('edit-mode');
      document.getElementById('btn-edit-warehouse').classList.remove('active');
      statusEl.innerHTML = 'Click "Add Isle" then<br>draw inside the warehouse.';
      removeEditHandles();
    }

    function selectIsle(isle) {
      if (selectedIsle && selectedIsle.element) {
        selectedIsle.element.classList.remove('isle-selected');
      }
      selectedIsle = isle;
      if (isle && isle.element) isle.element.classList.add('isle-selected');
    }

    function selectZone(zone) {
      if (selectedZone && selectedZone.element) {
        selectedZone.element.classList.remove('zone-selected');
      }
      selectedZone = zone;
      if (zone && zone.element) zone.element.classList.add('zone-selected');
    }

    let pendingDeleteEntity = null; // { entity, type }

    function deleteSelectedEntity() {
      if (!editMode) return;
      const entity = selectedIsle || selectedZone;
      const type   = selectedIsle ? 'isle' : selectedZone ? 'zone' : null;
      if (!entity) return;

      pendingDeleteEntity = { entity, type };

      if (type === 'isle') {
        const totalItems = entity.subsections.reduce((n, sub) => n + sub.shelves.reduce((m, sh) => m + sh.items.length, 0), 0);
        document.getElementById('delete-entity-title').textContent = `Delete Isle "${entity.label}"?`;
        document.getElementById('delete-entity-msg').textContent =
          totalItems > 0
            ? `This isle contains ${totalItems} item(s). They will all be permanently removed.`
            : `Isle "${entity.label}" will be permanently removed.`;
      } else {
        const zoneItemCount = entity.items ? entity.items.length : 0;
        document.getElementById('delete-entity-title').textContent = `Delete Zone "${entity.label}"?`;
        document.getElementById('delete-entity-msg').textContent =
          zoneItemCount > 0
            ? `This zone contains ${zoneItemCount} item(s). They will all be permanently removed.`
            : `Zone "${entity.label}" will be permanently removed.`;
      }
      show('modal-delete-entity');
    }

    function confirmDeleteEntity() {
      hide('modal-delete-entity');
      if (!pendingDeleteEntity) return;
      const { entity, type } = pendingDeleteEntity;
      pendingDeleteEntity = null;

      // Remove DOM element and edit handles
      document.querySelectorAll(`.edit-handle[data-type="${type}"][data-id="${entity.id}"]`)
        .forEach(el => el.remove());
      entity.element.remove();

      if (type === 'isle') {
        const idx = isles.indexOf(entity);
        if (idx !== -1) isles.splice(idx, 1);
        if (selectedIsle === entity) selectIsle(null);
        countEl.textContent = `Isles: ${isles.length}`;
        statusEl.textContent = `Isle "${entity.label}" deleted.`;
      } else {
        const idx = zones.indexOf(entity);
        if (idx !== -1) zones.splice(idx, 1);
        if (selectedZone === entity) selectZone(null);
        statusEl.textContent = `Zone "${entity.label}" deleted.`;
      }
    }

    function snapIsleMove(isle, newX, newY) {
      const w = isle.dimensions.width, h = isle.dimensions.height;
      const vEdges = [0, warehouse.clientWidth],  hEdges = [0, warehouse.clientHeight];
      for (const o of isles) {
        if (o.id === isle.id) continue;
        vEdges.push(o.position.x, o.position.x + o.dimensions.width);
        hEdges.push(o.position.y, o.position.y + o.dimensions.height);
      }
      for (const z of zones) {
        vEdges.push(z.position.x, z.position.x + z.dimensions.width);
        hEdges.push(z.position.y, z.position.y + z.dimensions.height);
      }
      let bestX = newX, bestDX = SNAP_THRESHOLD + 1;
      for (const ve of vEdges) {
        const dl = Math.abs(newX     - ve), dr = Math.abs(newX + w - ve);
        if (dl < bestDX) { bestDX = dl; bestX = ve;     }
        if (dr < bestDX) { bestDX = dr; bestX = ve - w; }
      }
      let bestY = newY, bestDY = SNAP_THRESHOLD + 1;
      for (const he of hEdges) {
        const dt = Math.abs(newY     - he), db = Math.abs(newY + h - he);
        if (dt < bestDY) { bestDY = dt; bestY = he;     }
        if (db < bestDY) { bestDY = db; bestY = he - h; }
      }
      return { x: bestX, y: bestY };
    }

    // Attach resize handle events
    document.querySelectorAll('.rh').forEach(handle => {
      handle.addEventListener('mousedown', (e) => {
        if (e.button !== 0) return;
        e.stopPropagation(); e.preventDefault();
        isResizing      = true;
        resizeEdge      = handle.dataset.edge;
        resizeStartMX   = e.clientX;
        resizeStartMY   = e.clientY;
        resizeStartW    = warehouse.clientWidth;
        resizeStartH    = warehouse.clientHeight;
        resizeStartPanX = panX;
        resizeStartPanY = panY;
      });
    });

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       DRAW MODE
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    function activateDrawMode() {
      if (drawMode === 'isle') { cancelDrawMode(); return; }
      if (drawMode) cancelDrawMode();
      if (editMode) cancelEditMode();
      drawMode = 'isle';
      warehouse.classList.add('drawing-mode');
      document.getElementById('btn-add-isle').classList.add('active');
      statusEl.textContent = 'Click & drag to draw an isle.';
    }
    function activateZoneMode() {
      if (drawMode === 'zone') { cancelDrawMode(); return; }
      if (drawMode) cancelDrawMode();
      if (editMode) cancelEditMode();
      drawMode = 'zone';
      warehouse.classList.add('drawing-mode');
      document.getElementById('btn-add-zone').classList.add('active');
      statusEl.textContent = 'Click & drag to draw a zone.';
    }
    function cancelDrawMode() {
      drawMode=null; isDrawing=false;
      warehouse.classList.remove('drawing-mode');
      document.getElementById('btn-add-isle').classList.remove('active');
      document.getElementById('btn-add-zone').classList.remove('active');
      preview.style.display='none';
      statusEl.innerHTML='Click "Add Isle" then<br>draw inside the warehouse.';
    }

    // Handle mousedown for entity (isle/zone) resize or rotate in edit mode
    warehouse.addEventListener('mousedown', (e) => {
      const handle = e.target.closest('.edit-handle');
      if (!handle || !editMode || e.button !== 0) return;
      e.stopPropagation(); e.preventDefault();
      const type   = handle.dataset.type;
      const id     = parseInt(handle.dataset.id);
      const entity = type === 'isle' ? isles.find(i => i.id===id) : zones.find(z => z.id===id);
      if (!entity) return;

      if (handle.dataset.edge === 'rotate') {
        // Start rotation
        isRotating         = true;
        rotatingEntity     = entity;
        rotatingEntityType = type;
        rotateStartAngle   = entity.rotation || 0;
        const wRect = warehouse.getBoundingClientRect();
        const bx = parseFloat(getComputedStyle(warehouse).borderLeftWidth) || 0;
        const by = parseFloat(getComputedStyle(warehouse).borderTopWidth)  || 0;
        rotateCenterX = wRect.left + (entity.position.x + entity.dimensions.width  / 2 + bx) * currentZoom;
        rotateCenterY = wRect.top  + (entity.position.y + entity.dimensions.height / 2 + by) * currentZoom;
        rotateStartMouseAngle = Math.atan2(e.clientY - rotateCenterY, e.clientX - rotateCenterX) * 180 / Math.PI;
      } else {
        // Start resize
        isEntityResizing       = true;
        entityResizeTarget     = entity;
        entityResizeTargetType = type;
        entityResizeEdge       = handle.dataset.edge;
        entityResizeStartMX    = e.clientX;
        entityResizeStartMY    = e.clientY;
        entityResizeStartX     = entity.position.x;
        entityResizeStartY     = entity.position.y;
        entityResizeStartW     = entity.dimensions.width;
        entityResizeStartH     = entity.dimensions.height;
      }
    });

    warehouse.addEventListener('mousedown', (e) => {
      if (!drawMode || e.button!==0 || e.target.closest('.isle') || e.target.closest('.zone')) return;
      isDrawing=true;
      const p=snapPoint(...Object.values(getRelativePos(e))); startX=p.x; startY=p.y;
      Object.assign(preview.style,{left:`${startX}px`,top:`${startY}px`,width:'0px',height:'0px',display:'block'});
      e.preventDefault();
    });
    window.addEventListener('mousemove', (e) => {
      // Pan
      if (isPanning) {
        panX += e.clientX - panLastX; panY += e.clientY - panLastY;
        panLastX = e.clientX; panLastY = e.clientY;
        applyTransform();
      }
      // Warehouse resize
      if (isResizing) {
        const dxVP = e.clientX - resizeStartMX;
        const dyVP = e.clientY - resizeStartMY;
        const dxL  = dxVP / currentZoom, dyL = dyVP / currentZoom;
        let newW = resizeStartW, newH = resizeStartH;
        let newPanX = resizeStartPanX, newPanY = resizeStartPanY;
        if (resizeEdge.includes('e')) newW  = Math.max(150, resizeStartW + dxL);
        if (resizeEdge.includes('w')) { newW = Math.max(150, resizeStartW - dxL); newPanX = resizeStartPanX + (resizeStartW - newW) * currentZoom; }
        if (resizeEdge.includes('s')) newH  = Math.max(100, resizeStartH + dyL);
        if (resizeEdge.includes('n')) { newH = Math.max(100, resizeStartH - dyL); newPanY = resizeStartPanY + (resizeStartH - newH) * currentZoom; }
        warehouse.style.width  = newW + 'px';
        warehouse.style.height = newH + 'px';
        panX = newPanX; panY = newPanY;
        applyTransform();
      }
      // Entity (isle/zone) resize
      if (isEntityResizing && entityResizeTarget) {
        const dxL = (e.clientX - entityResizeStartMX) / currentZoom;
        const dyL = (e.clientY - entityResizeStartMY) / currentZoom;
        const MIN = 30;
        let newX = entityResizeStartX, newY = entityResizeStartY;
        let newW = entityResizeStartW, newH = entityResizeStartH;
        const edge = entityResizeEdge;
        if (edge.includes('e')) newW = Math.max(MIN, entityResizeStartW + dxL);
        if (edge.includes('w')) { newW = Math.max(MIN, entityResizeStartW - dxL); newX = entityResizeStartX + entityResizeStartW - newW; }
        if (edge.includes('s')) newH = Math.max(MIN, entityResizeStartH + dyL);
        if (edge.includes('n')) { newH = Math.max(MIN, entityResizeStartH - dyL); newY = entityResizeStartY + entityResizeStartH - newH; }
        // Clamp within warehouse for isles; zones may extend outside
        if (entityResizeTargetType === 'isle') {
          newX = Math.max(0, newX);
          newY = Math.max(0, newY);
          newW = Math.min(newW, warehouse.clientWidth  - newX);
          newH = Math.min(newH, warehouse.clientHeight - newY);
        }
        entityResizeTarget.position.x          = newX;
        entityResizeTarget.position.y          = newY;
        entityResizeTarget.dimensions.width    = newW;
        entityResizeTarget.dimensions.height   = newH;
        const el = entityResizeTarget.element;
        el.style.left = newX+'px'; el.style.top  = newY+'px';
        el.style.width= newW+'px'; el.style.height=newH+'px';
        updateHandlesForEntity(entityResizeTarget, entityResizeTargetType);
      }
      // Entity rotation
      if (isRotating && rotatingEntity) {
        const currentMouseAngle = Math.atan2(e.clientY - rotateCenterY, e.clientX - rotateCenterX) * 180 / Math.PI;
        let newRotation = rotateStartAngle + (currentMouseAngle - rotateStartMouseAngle);
        if (e.shiftKey) newRotation = Math.round(newRotation / 15) * 15;
        rotatingEntity.rotation = newRotation;
        rotatingEntity.element.style.transform = `rotate(${newRotation}deg)`;
        updateHandlesForEntity(rotatingEntity, rotatingEntityType);
      }
      // Isle drag
      if (isDraggingIsle && draggingIsle) {
        const dxL = (e.clientX - isleStartMX) / currentZoom;
        const dyL = (e.clientY - isleStartMY) / currentZoom;
        if (Math.abs(dxL) > 2 || Math.abs(dyL) > 2) isleDragMoved = true;
        let newX = clamp(isleStartX + dxL, 0, warehouse.clientWidth  - draggingIsle.dimensions.width);
        let newY = clamp(isleStartY + dyL, 0, warehouse.clientHeight - draggingIsle.dimensions.height);
        const snapped = snapIsleMove(draggingIsle, newX, newY);
        draggingIsle.position.x = snapped.x;
        draggingIsle.position.y = snapped.y;
        draggingIsle.element.style.left = snapped.x + 'px';
        draggingIsle.element.style.top  = snapped.y + 'px';
        if (editMode) updateHandlesForEntity(draggingIsle, 'isle');
      }
      // Zone drag (no warehouse-bounds clamping ‚Äî zones may be placed outside)
      if (isDraggingZone && draggingZone) {
        const dxL = (e.clientX - zoneStartMX) / currentZoom;
        const dyL = (e.clientY - zoneStartMY) / currentZoom;
        if (Math.abs(dxL) > 2 || Math.abs(dyL) > 2) zoneDragMoved = true;
        let newX = zoneStartX + dxL;
        let newY = zoneStartY + dyL;
        const snapped = snapZoneMove(draggingZone, newX, newY);
        draggingZone.position.x = snapped.x;
        draggingZone.position.y = snapped.y;
        draggingZone.element.style.left = snapped.x + 'px';
        draggingZone.element.style.top  = snapped.y + 'px';
        if (editMode) updateHandlesForEntity(draggingZone, 'zone');
      }
      // Draw preview
      if (!isDrawing) return;
      const raw=getRelativePos(e);
      const p=snapPoint(raw.x,raw.y);
      const x=Math.min(p.x,startX), y=Math.min(p.y,startY);
      Object.assign(preview.style,{left:`${x}px`,top:`${y}px`,width:`${Math.abs(p.x-startX)}px`,height:`${Math.abs(p.y-startY)}px`});
    });
    window.addEventListener('mouseup', (e) => {
      if (e.button === 1) { isPanning = false; viewport.classList.remove('panning'); }
      if (isResizing)       { isResizing = false; resizeEdge = null; }
      if (isEntityResizing) { isEntityResizing = false; entityResizeTarget = null; }
      if (isRotating)       { isRotating = false; rotatingEntity = null; }
      if (isDraggingIsle)   { isDraggingIsle = false; draggingIsle = null; }
      if (isDraggingZone)   { isDraggingZone = false; draggingZone = null; }
      if (!isDrawing) return;
      isDrawing=false; preview.style.display='none';
      const raw=getRelativePos(e);
      const p=snapPoint(raw.x,raw.y);
      const x=Math.min(p.x,startX), y=Math.min(p.y,startY);
      const w=Math.abs(p.x-startX), h=Math.abs(p.y-startY);
      if (w<10||h<10) return;
      const mode=drawMode;
      cancelDrawMode();
      if (mode==='zone') beginZoneCreation(x,y,w,h);
      else               beginIsleCreation(x,y,w,h);
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') { cancelDrawMode(); cancelEditMode(); return; }
      // Don't intercept shortcuts when typing in an input / textarea
      const tag = document.activeElement?.tagName;
      if (tag === 'INPUT' || tag === 'TEXTAREA') return;
      if ((e.ctrlKey || e.metaKey) && e.key === 'c') {
        if (editMode && selectedIsle) { copySelectedIsle(); e.preventDefault(); }
      }
      if ((e.ctrlKey || e.metaKey) && e.key === 'v') {
        if (editMode && copiedIsle) { openPasteModal(); e.preventDefault(); }
      }
      if ((e.key === 'Delete' || e.key === 'Backspace') && editMode) {
        if (selectedIsle || selectedZone) { deleteSelectedEntity(); e.preventDefault(); }
      }
    });

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       ISLE CREATION ‚Äî STEP 1: name + shelves/subsection
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    function beginIsleCreation(x,y,w,h) {
      const color = randomHexColor();
      const id    = ++isleCounter;

      // Draw placeholder isle on canvas
      const el = document.createElement('div');
      el.className='isle';
      Object.assign(el.style,{left:`${x}px`,top:`${y}px`,width:`${w}px`,height:`${h}px`,borderColor:color});
      el.dataset.isleId=id;
      el.innerHTML=`<div class="isle-header"><span class="isle-label" style="color:${color}">‚Ä¶</span></div>`;
      warehouse.appendChild(el);

      pendingIsle = { id, label:'', color, shelfColor:'#aaaaaa',
                      fillColor:'#ffffff', fillOpacity:0, labelColor:color, rotation:0,
                      position:{x,y}, dimensions:{width:w,height:h}, element:el,
                      shelfCount:1, shelfLabels:[], subsectionStart:1, subsectionCount:1,
                      facing:'right', subsections:[], createdAt:new Date().toISOString() };

      document.getElementById('isle-name-input').value='';
      document.getElementById('isle-name-input').style.borderColor='';
      document.getElementById('shelf-count-input').value=1;
      document.getElementById('isle-color-input').value=color;
      document.getElementById('isle-label-color-input').value=color;
      document.getElementById('shelf-color-input').value='#aaaaaa';
      document.getElementById('isle-fill-color').value='#ffffff';
      document.getElementById('isle-fill-opacity').value=0;
      document.getElementById('isle-fill-opacity-label').textContent='0%';
      setFacing('right');
      show('modal-count');
      document.getElementById('isle-name-input').focus();
    }

    function confirmStep1() {
      const nameEl = document.getElementById('isle-name-input');
      const name   = nameEl.value.trim();
      if (!name) { nameEl.style.borderColor='#e53935'; nameEl.focus(); return; }
      nameEl.style.borderColor='';

      const count = Math.min(Math.max(parseInt(document.getElementById('shelf-count-input').value,10)||1,1),26);
      pendingIsle.label      = name;
      pendingIsle.shelfCount = count;
      pendingIsle.facing     = pendingFacing;
      pendingIsle.shelfColor  = document.getElementById('shelf-color-input').value || '#aaaaaa';
      pendingIsle.fillColor   = document.getElementById('isle-fill-color').value || '#ffffff';
      pendingIsle.fillOpacity = parseInt(document.getElementById('isle-fill-opacity').value, 10) || 0;
      pendingIsle.labelColor  = document.getElementById('isle-label-color-input').value || pendingIsle.color;
      const lblEl = pendingIsle.element.querySelector('.isle-label');
      if (lblEl) { lblEl.textContent = name; lblEl.style.color = pendingIsle.labelColor; }

      hide('modal-count');
      document.getElementById('subsection-config-title').textContent = `Subsection Setup ‚Äî ${name}`;
      document.getElementById('subsection-start-input').value=1;
      document.getElementById('subsection-count-input').value=1;
      show('modal-subsections');
      document.getElementById('subsection-count-input').focus();
    }

    function goBackToStep1() { hide('modal-subsections'); show('modal-count'); }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       ISLE CREATION ‚Äî STEP 2: subsection config
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    function confirmStep2() {
      const start = Math.max(parseInt(document.getElementById('subsection-start-input').value,10)||1,1);
      const count = Math.max(parseInt(document.getElementById('subsection-count-input').value,10)||1,1);
      pendingIsle.subsectionStart = start;
      pendingIsle.subsectionCount = count;

      hide('modal-subsections');

      // Build shelf label inputs
      const list = document.getElementById('shelf-list');
      list.innerHTML='';
      for (let i=1; i<=pendingIsle.shelfCount; i++) {
        const letter = String.fromCharCode(64+i);
        const row = document.createElement('div');
        row.className='shelf-row';
        row.innerHTML=`<span class="shelf-num">Shelf ${i}</span><input type="text" value="${letter}" />`;
        list.appendChild(row);
      }
      document.getElementById('modal-labels-title').textContent=`Label Shelves ‚Äî ${pendingIsle.label}`;
      show('modal-labels');
      list.querySelector('input')?.focus();
    }

    function goBackToStep2() { hide('modal-labels'); show('modal-subsections'); }

    function cancelIsleCreation() {
      if (pendingIsle) { pendingIsle.element.remove(); pendingIsle=null; isleCounter--; }
      ['modal-count','modal-subsections','modal-labels'].forEach(hide);
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       ISLE CREATION ‚Äî STEP 3: finalize
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    function confirmStep3() {
      const shelfLabels = [...document.querySelectorAll('#shelf-list input')]
        .map((inp,idx) => inp.value.trim() || String.fromCharCode(65+idx));
      pendingIsle.shelfLabels = shelfLabels;

      const { subsectionStart, subsectionCount, shelfCount, element:isleEl, id:isleId } = pendingIsle;

      // Build isle body with subsection rects
      const body = document.createElement('div');
      body.className='isle-body';

      const facing     = pendingIsle.facing;
      const shelfColor = pendingIsle.shelfColor || '#aaaaaa';

      for (let s=0; s<subsectionCount; s++) {
        const num   = subsectionStart + s;

        const subEl = document.createElement('div');
        subEl.className = `subsection facing-${facing}`;
        subEl.dataset.subsectionNum = num;

        // Subsection number label
        const subNumEl = document.createElement('div');
        subNumEl.className = 'sub-number';
        subNumEl.textContent = num;
        subEl.appendChild(subNumEl);

        // Shelf slots row with wall indicator
        const shelvesDiv = document.createElement('div');
        shelvesDiv.className = 'sub-shelves';

        const wallEl = document.createElement('div');
        wallEl.className = 'wall-indicator';

        const subId   = ++subsectionCounter;
        const shelves = shelfLabels.map((lbl, j) => ({
          id:           ++shelfCounter,
          isleId,
          subsectionId: subId,
          shelfNumber:  j+1,
          label:        lbl,
          items:        [],
          element:      null,
        }));

        const makeSlot = (shelf) => {
          const slot = document.createElement('div');
          slot.className = 'shelf-slot';
          slot.textContent = shelf.label;
          slot.style.borderColor = shelfColor;
          shelf.element = slot;
          return slot;
        };

        if (facing === 'left') {
          // Wall on right; shelves reversed so first shelf (A) is rightmost
          [...shelves].reverse().forEach(shelf => shelvesDiv.appendChild(makeSlot(shelf)));
          shelvesDiv.appendChild(wallEl);
        } else {
          // Wall on left; shelves in normal order so first shelf (A) is leftmost
          shelvesDiv.appendChild(wallEl);
          shelves.forEach(shelf => shelvesDiv.appendChild(makeSlot(shelf)));
        }
        subEl.appendChild(shelvesDiv);

        const subObj = { id:subId, isleId, number:num, element:subEl, shelves };
        pendingIsle.subsections.push(subObj);

        // Clicking a subsection rect goes directly to shelf select
        subEl.addEventListener('click', (e) => {
          e.stopPropagation();
          if (drawMode || editMode || isleDragMoved) return;
          activeIsle       = isles.find(i=>i.id===isleId);
          activeSubsection = subObj;
          openShelfSelect(subObj);
        });

        body.appendChild(subEl);
      }

      isleEl.appendChild(body);
      applyIsleFill(isleEl, pendingIsle.fillColor || '#ffffff', pendingIsle.fillOpacity || 0);
      isles.push(pendingIsle);
      attachIsleClickHandler(pendingIsle);

      console.log('Isle created:', pendingIsle);
      countEl.textContent=`Isles: ${isles.length}`;
      statusEl.textContent=`${pendingIsle.label} added. Draw another or press Esc.`;
      pendingIsle=null;
      hide('modal-labels');
    }

    /* Isle click/drag handler */
    function attachIsleClickHandler(isle) {
      isle.element.addEventListener('mousedown', (e) => {
        if (!editMode || e.button !== 0) return;
        e.stopPropagation(); e.preventDefault();
        selectIsle(isle);
        selectZone(null);
        isDraggingIsle = true;
        draggingIsle   = isle;
        isleDragMoved  = false;
        isleStartMX    = e.clientX;
        isleStartMY    = e.clientY;
        isleStartX     = isle.position.x;
        isleStartY     = isle.position.y;
      });
      isle.element.addEventListener('click', () => {
        if (drawMode || editMode || isleDragMoved) return;
        activeIsle = isle;
        if (isle.subsections.length===1) {
          activeSubsection = isle.subsections[0];
          openShelfSelect(activeSubsection);
        } else {
          openSubsectionSelect(isle);
        }
      });
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       SUBSECTION SELECT
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    function openSubsectionSelect(isle) {
      document.getElementById('subsection-select-title').textContent = `${isle.label} ‚Äî Select a Subsection`;
      const list = document.getElementById('subsection-select-list');
      list.innerHTML='';
      isle.subsections.forEach(sub => {
        const totalItems = sub.shelves.reduce((n,sh)=>n+sh.items.length,0);
        const row = document.createElement('div');
        row.className='select-row';
        row.innerHTML=`<span class="row-name">Subsection ${sub.number}</span>
                       <span class="row-meta">${sub.shelves.length} shelves ¬∑ ${totalItems} items</span>`;
        row.addEventListener('click', ()=>{ activeSubsection=sub; hide('modal-subsection-select'); openShelfSelect(sub); });
        list.appendChild(row);
      });
      show('modal-subsection-select');
    }

    function backToSubsectionSelect() {
      hide('modal-shelf-select');
      if (activeIsle.subsections.length===1) closeAllModals();
      else openSubsectionSelect(activeIsle);
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       SHELF SELECT
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    function openShelfSelect(sub) {
      document.getElementById('shelf-select-title').textContent =
        `${activeIsle.label} ‚Ä∫ Sub ${sub.number} ‚Äî Select a Shelf`;
      const list = document.getElementById('shelf-select-list');
      list.innerHTML='';
      sub.shelves.forEach(shelf => {
        const row = document.createElement('div');
        row.className='select-row';
        row.innerHTML=`<span class="row-name">${shelf.label}</span>
                       <span class="row-meta">${shelf.items.length} item${shelf.items.length!==1?'s':''}</span>`;
        row.addEventListener('click', ()=>selectShelf(shelf));
        list.appendChild(row);
      });
      show('modal-shelf-select');
    }

    function selectShelf(shelf) {
      activeShelf = shelf;
      hide('modal-shelf-select');
      document.getElementById('shelf-actions-title').textContent =
        `${activeIsle.label} ‚Ä∫ Sub ${activeSubsection.number} ‚Ä∫ ${shelf.label}`;
      document.getElementById('shelf-actions-subtitle').textContent =
        `${shelf.items.length} item${shelf.items.length!==1?'s':''} on this shelf`;
      show('modal-shelf-actions');
    }

    function backToShelfSelect() { hide('modal-shelf-actions'); openShelfSelect(activeSubsection); }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       ADD SHELF
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    function openAddShelf() {
      hide('modal-shelf-select');
      document.getElementById('add-shelf-subtitle').textContent =
        `${activeIsle.label} ‚Ä∫ Sub ${activeSubsection.number}`;
      const inp = document.getElementById('add-shelf-name-input');
      inp.value = ''; inp.style.borderColor = '';
      show('modal-add-shelf');
      inp.focus();
    }

    function backToShelfSelectFromAdd() {
      hide('modal-add-shelf');
      openShelfSelect(activeSubsection);
    }

    function confirmAddShelf() {
      const inp = document.getElementById('add-shelf-name-input');
      const label = inp.value.trim();
      inp.style.borderColor = '';
      if (!label) { inp.style.borderColor = '#e53935'; inp.focus(); return; }

      const shelf = {
        id:           ++shelfCounter,
        isleId:       activeIsle.id,
        subsectionId: activeSubsection.id,
        shelfNumber:  activeSubsection.shelves.length + 1,
        label,
        items:        [],
        element:      null,
      };

      const slot = document.createElement('div');
      slot.className = 'shelf-slot';
      slot.textContent = shelf.label;
      slot.style.borderColor = activeIsle.shelfColor;
      shelf.element = slot;

      // Insert respecting facing: left-facing has wall as last child; others have wall as first child
      const shelvesDiv = activeSubsection.element.querySelector('.sub-shelves');
      if (activeIsle.facing === 'left') {
        shelvesDiv.insertBefore(slot, shelvesDiv.lastElementChild);
      } else {
        shelvesDiv.appendChild(slot);
      }

      activeSubsection.shelves.push(shelf);
      hide('modal-add-shelf');
      openShelfSelect(activeSubsection);
    }

    function deleteShelf() {
      const itemCount = activeShelf.items.length;
      if (itemCount > 0) {
        document.getElementById('confirm-delete-msg').textContent =
          `Shelf "${activeShelf.label}" still has ${itemCount} item(s) on it. Remove all items before deleting.`;
        document.getElementById('modal-confirm-delete')
          .querySelector('.btn-danger').style.display = 'none';
        show('modal-confirm-delete');
        return;
      }
      document.getElementById('confirm-delete-msg').textContent =
        `Permanently delete shelf "${activeShelf.label}"? This cannot be undone.`;
      document.getElementById('modal-confirm-delete')
        .querySelector('.btn-danger').style.display = '';
      show('modal-confirm-delete');
    }

    function confirmDeleteShelf() {
      hide('modal-confirm-delete');
      activeSubsection.shelves = activeSubsection.shelves.filter(s => s.id !== activeShelf.id);
      if (activeShelf.element) activeShelf.element.remove();
      activeShelf = null;
      hide('modal-shelf-actions');
      if (activeSubsection.shelves.length === 0) closeAllModals();
      else openShelfSelect(activeSubsection);
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       ADD ITEM
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    function openAddItem() {
      hide('modal-shelf-actions');
      document.getElementById('add-item-subtitle').textContent =
        `${activeIsle.label} ‚Ä∫ Sub ${activeSubsection.number} ‚Ä∫ ${activeShelf.label}`;
      ['item-id-input','item-type-input','item-category-input','item-notes-input']
        .forEach(id=>{ const el=document.getElementById(id); el.value=''; el.style.borderColor=''; });
      show('modal-add-item');
      document.getElementById('item-id-input').focus();
    }

    function backFromAddItem() {
      hide('modal-add-item');
      if (activeZoneForItems) {
        openZoneActions(activeZoneForItems);
      } else {
        hide('modal-remove-items');
        selectedItemIds.clear();
        selectShelf(activeShelf);
      }
    }

    function backToShelfActions() {
      hide('modal-add-item'); hide('modal-remove-items');
      selectedItemIds.clear();
      selectShelf(activeShelf);
    }

    function confirmAddItem() {
      const idEl   = document.getElementById('item-id-input');
      const itemId = idEl.value.trim();
      idEl.style.borderColor='';
      if (!itemId) { idEl.style.borderColor='#e53935'; idEl.focus(); return; }

      if (activeZoneForItems) {
        const item = {
          id:      ++itemCounter,
          itemId,
          type:     document.getElementById('item-type-input').value.trim(),
          category: document.getElementById('item-category-input').value.trim(),
          notes:    document.getElementById('item-notes-input').value.trim(),
          zoneId:  activeZoneForItems.id,
          addedAt: new Date().toISOString(),
        };
        activeZoneForItems.items.push(item);
        hide('modal-add-item');
        openZoneActions(activeZoneForItems);
      } else {
        const item = {
          id:           ++itemCounter,
          itemId,
          type:         document.getElementById('item-type-input').value.trim(),
          category:     document.getElementById('item-category-input').value.trim(),
          notes:        document.getElementById('item-notes-input').value.trim(),
          shelfId:      activeShelf.id,
          subsectionId: activeSubsection.id,
          isleId:       activeIsle.id,
          addedAt:      new Date().toISOString(),
        };
        activeShelf.items.push(item);
        hide('modal-add-item');
        selectShelf(activeShelf);
      }
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       ZONE ITEM MANAGEMENT
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    function openZoneActions(zone) {
      activeZoneForItems = zone;
      document.getElementById('zone-actions-title').textContent = `Zone: ${escHtml(zone.label)}`;
      const n = zone.items.length;
      document.getElementById('zone-actions-subtitle').textContent =
        `${n} item${n !== 1 ? 's' : ''} in this zone`;
      show('modal-zone-actions');
    }

    function openAddZoneItem() {
      hide('modal-zone-actions');
      document.getElementById('add-item-subtitle').textContent =
        `Zone: ${escHtml(activeZoneForItems.label)}`;
      ['item-id-input','item-type-input','item-category-input','item-notes-input']
        .forEach(id => { const el = document.getElementById(id); el.value = ''; el.style.borderColor = ''; });
      show('modal-add-item');
      document.getElementById('item-id-input').focus();
    }

    function backToZoneActions() {
      hide('modal-zone-items');
      selectedZoneItemIds.clear();
      if (activeZoneForItems) openZoneActions(activeZoneForItems);
    }

    function openZoneItemList() {
      hide('modal-zone-actions');
      selectedZoneItemIds.clear();
      renderZoneItemList();
      document.getElementById('zone-items-title').textContent =
        `Zone: ${escHtml(activeZoneForItems.label)}`;
      updateZoneSelectedCount();
      show('modal-zone-items');
    }

    function renderZoneItemList() {
      const list = document.getElementById('zone-item-list');
      list.innerHTML = '';
      if (!activeZoneForItems || activeZoneForItems.items.length === 0) {
        list.innerHTML = '<p class="no-items-msg">No items in this zone.</p>';
        return;
      }
      activeZoneForItems.items.forEach(item => {
        const row = document.createElement('div');
        row.className = 'item-row' + (selectedZoneItemIds.has(item.id) ? ' selected' : '');
        row.dataset.itemId = item.id;
        row.innerHTML = `
          <span class="item-id-label">${escHtml(item.itemId)}</span>
          <span class="item-meta">${[item.type, item.category].filter(Boolean).map(escHtml).join(' ¬∑ ')}</span>
          ${item.notes ? `<span class="item-meta" style="font-style:italic">${escHtml(item.notes)}</span>` : ''}`;
        row.addEventListener('click', (e) => toggleZoneItemSelection(item.id, e.ctrlKey || e.metaKey));
        list.appendChild(row);
      });
    }

    function toggleZoneItemSelection(itemId, multi) {
      if (!multi) {
        if (selectedZoneItemIds.size === 1 && selectedZoneItemIds.has(itemId)) selectedZoneItemIds.clear();
        else { selectedZoneItemIds.clear(); selectedZoneItemIds.add(itemId); }
      } else {
        if (selectedZoneItemIds.has(itemId)) selectedZoneItemIds.delete(itemId);
        else selectedZoneItemIds.add(itemId);
      }
      renderZoneItemList(); updateZoneSelectedCount();
    }

    function updateZoneSelectedCount() {
      const n = selectedZoneItemIds.size;
      document.getElementById('zone-selected-count').textContent = `${n} selected`;
      document.getElementById('btn-zone-remove-confirm').disabled = (n === 0);
    }

    function confirmRemoveZoneItems() {
      if (selectedZoneItemIds.size === 0) return;
      activeZoneForItems.items = activeZoneForItems.items.filter(i => !selectedZoneItemIds.has(i.id));
      selectedZoneItemIds.clear();
      hide('modal-zone-items');
      openZoneActions(activeZoneForItems);
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       REMOVE ITEMS
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    function openRemoveItems() {
      hide('modal-shelf-actions');
      selectedItemIds.clear();
      renderItemList();
      document.getElementById('remove-items-title').textContent =
        `${activeIsle.label} ‚Ä∫ Sub ${activeSubsection.number} ‚Ä∫ ${activeShelf.label}`;
      updateSelectedCount();
      show('modal-remove-items');
    }

    function renderItemList() {
      const list = document.getElementById('item-list');
      list.innerHTML='';
      if (activeShelf.items.length===0) {
        list.innerHTML='<p class="no-items-msg">No items on this shelf.</p>'; return;
      }
      activeShelf.items.forEach(item => {
        const row = document.createElement('div');
        row.className='item-row'+(selectedItemIds.has(item.id)?' selected':'');
        row.dataset.itemId=item.id;
        row.innerHTML=`
          <span class="item-id-label">${item.itemId}</span>
          <span class="item-meta">${[item.type,item.category].filter(Boolean).join(' ¬∑ ')}</span>
          ${item.notes?`<span class="item-meta" style="font-style:italic">${item.notes}</span>`:''}`;
        row.addEventListener('click',(e)=>toggleItemSelection(item.id,e.ctrlKey||e.metaKey));
        list.appendChild(row);
      });
    }

    function toggleItemSelection(itemId, multi) {
      if (!multi) {
        if (selectedItemIds.size===1&&selectedItemIds.has(itemId)) selectedItemIds.clear();
        else { selectedItemIds.clear(); selectedItemIds.add(itemId); }
      } else {
        if (selectedItemIds.has(itemId)) selectedItemIds.delete(itemId);
        else selectedItemIds.add(itemId);
      }
      renderItemList(); updateSelectedCount();
    }

    function updateSelectedCount() {
      const n=selectedItemIds.size;
      document.getElementById('selected-count').textContent=`${n} selected`;
      document.getElementById('btn-remove-confirm').disabled=(n===0);
    }

    function confirmRemoveItems() {
      if (selectedItemIds.size===0) return;
      activeShelf.items=activeShelf.items.filter(i=>!selectedItemIds.has(i.id));
      selectedItemIds.clear();
      hide('modal-remove-items');
      selectShelf(activeShelf);
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       SEARCH
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    function onSearchInput() {
      if (!document.getElementById('search-input').value.trim()) clearSearch();
    }

    function runSearch() {
      const query = document.getElementById('search-input').value.trim();
      if (!query) return;
      clearHighlights();

      const q = query.toLowerCase();
      const matches=[];
      for (const isle of isles)
        for (const sub of isle.subsections)
          for (const shelf of sub.shelves)
            for (const item of shelf.items)
              if (item.itemId.toLowerCase().includes(q))
                matches.push({type:'isle',isle,sub,shelf,item});

      const zoneMatches=[];
      for (const zone of zones)
        for (const item of zone.items)
          if (item.itemId.toLowerCase().includes(q))
            zoneMatches.push({type:'zone',zone,item});

      const resultsEl = document.getElementById('search-results');
      const clearBtn  = document.getElementById('btn-clear');
      resultsEl.innerHTML=''; resultsEl.classList.remove('hidden'); clearBtn.style.display='';

      if (matches.length===0 && zoneMatches.length===0) {
        resultsEl.innerHTML=`<div class="search-result-card not-found">No item found matching "<strong>${escHtml(query)}</strong>"</div>`;
        return;
      }

      // Highlight isle/sub/shelf
      const seenIsles=new Set(), seenSubs=new Set(), seenShelves=new Set();
      matches.forEach(({isle,sub,shelf})=>{
        if (!seenIsles.has(isle.id))   { isle.element.classList.add('isle-highlight');   seenIsles.add(isle.id); }
        if (!seenSubs.has(sub.id))     { sub.element.classList.add('sub-highlight');      seenSubs.add(sub.id); }
        if (shelf.element && !seenShelves.has(shelf.id)) { shelf.element.classList.add('shelf-highlight'); seenShelves.add(shelf.id); }
      });

      // Highlight zones
      const seenZones=new Set();
      zoneMatches.forEach(({zone})=>{
        if (!seenZones.has(zone.id)) { zone.element.classList.add('zone-highlight'); seenZones.add(zone.id); }
      });

      // Render isle result cards
      matches.forEach(({isle,sub,shelf,item})=>{
        const card=document.createElement('div');
        card.className='search-result-card';
        const parts=[
          `<span class="lbl">I:</span>${escHtml(isle.label)}`,
          `<span class="sep">|</span><span class="lbl">SUB:</span>${sub.number}`,
          `<span class="sep">|</span><span class="lbl">SH:</span>${escHtml(shelf.label)}`,
          `<span class="sep">|</span><span class="lbl">ID:</span>${escHtml(item.itemId)}`,
          item.type     ? `<span class="sep">|</span><span class="lbl">T:</span>${escHtml(item.type)}`       : '',
          item.category ? `<span class="sep">|</span><span class="lbl">CAT:</span>${escHtml(item.category)}` : '',
        ].filter(Boolean).join('');
        card.innerHTML=`<div class="result-line">${parts}</div>`;
        card.style.cursor='pointer';
        card.addEventListener('click',()=>isle.element.scrollIntoView({behavior:'smooth',block:'nearest'}));
        resultsEl.appendChild(card);
      });

      // Render zone result cards
      zoneMatches.forEach(({zone,item})=>{
        const card=document.createElement('div');
        card.className='search-result-card';
        card.style.borderLeftColor='#8b5cf6';
        const parts=[
          `<span class="lbl">Z:</span>${escHtml(zone.label)}`,
          `<span class="sep">|</span><span class="lbl">ID:</span>${escHtml(item.itemId)}`,
          item.type     ? `<span class="sep">|</span><span class="lbl">T:</span>${escHtml(item.type)}`       : '',
          item.category ? `<span class="sep">|</span><span class="lbl">CAT:</span>${escHtml(item.category)}` : '',
        ].filter(Boolean).join('');
        card.innerHTML=`<div class="result-line">${parts}</div>`;
        card.style.cursor='pointer';
        card.addEventListener('click',()=>zone.element.scrollIntoView({behavior:'smooth',block:'nearest'}));
        resultsEl.appendChild(card);
      });
    }

    function clearSearch() {
      document.getElementById('search-input').value='';
      document.getElementById('search-results').classList.add('hidden');
      document.getElementById('search-results').innerHTML='';
      document.getElementById('btn-clear').style.display='none';
      clearHighlights();
    }

    function clearHighlights() {
      document.querySelectorAll('.isle-highlight') .forEach(el=>el.classList.remove('isle-highlight'));
      document.querySelectorAll('.sub-highlight')  .forEach(el=>el.classList.remove('sub-highlight'));
      document.querySelectorAll('.shelf-highlight').forEach(el=>el.classList.remove('shelf-highlight'));
      document.querySelectorAll('.zone-highlight') .forEach(el=>el.classList.remove('zone-highlight'));
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       COPY / PASTE ISLE
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    function copySelectedIsle() {
      if (!selectedIsle) return;
      // Snapshot all data needed to reconstruct ‚Äî items excluded intentionally
      copiedIsle = {
        color:           selectedIsle.color,
        shelfColor:      selectedIsle.shelfColor,
        fillColor:       selectedIsle.fillColor   || '#ffffff',
        fillOpacity:     selectedIsle.fillOpacity != null ? selectedIsle.fillOpacity : 0,
        labelColor:      selectedIsle.labelColor  || selectedIsle.color,
        rotation:        selectedIsle.rotation    || 0,
        facing:          selectedIsle.facing,
        dimensions:      { ...selectedIsle.dimensions },
        shelfLabels:     [...selectedIsle.shelfLabels],
        subsectionStart: selectedIsle.subsectionStart,
        subsectionCount: selectedIsle.subsectionCount,
        position:        { ...selectedIsle.position },
        subsections:     selectedIsle.subsections.map(sub => ({
          number: sub.number,
          shelves: sub.shelves.map(sh => ({
            shelfNumber: sh.shelfNumber,
            label:       sh.label,
          })),
        })),
        sourceLabel: selectedIsle.label,
      };
      statusEl.textContent = `Copied "${selectedIsle.label}". Press Ctrl+V to paste.`;
    }

    function openPasteModal() {
      if (!copiedIsle) return;
      const inp = document.getElementById('paste-isle-name');
      inp.value = copiedIsle.sourceLabel + ' (copy)';
      inp.style.borderColor = '';
      document.getElementById('paste-isle-subtitle').textContent =
        `Copying "${copiedIsle.sourceLabel}" ‚Äî structure, colors, and facing. Items will not be copied.`;
      show('modal-paste-isle');
      inp.focus(); inp.select();
    }

    function cancelPaste() { hide('modal-paste-isle'); }

    function pasteIsle() {
      const nameEl = document.getElementById('paste-isle-name');
      const name   = nameEl.value.trim();
      if (!name) { nameEl.style.borderColor = '#e53935'; nameEl.focus(); return; }
      nameEl.style.borderColor = '';

      const src = copiedIsle;
      const id  = ++isleCounter;
      const x   = Math.min(src.position.x + 30, Math.max(0, warehouse.clientWidth  - src.dimensions.width));
      const y   = Math.min(src.position.y + 30, Math.max(0, warehouse.clientHeight - src.dimensions.height));

      const el = document.createElement('div');
      el.className = 'isle';
      Object.assign(el.style, {
        left: `${x}px`, top: `${y}px`,
        width: `${src.dimensions.width}px`, height: `${src.dimensions.height}px`,
        borderColor: src.color,
        transform: `rotate(${src.rotation}deg)`,
      });
      el.dataset.isleId = id;
      el.innerHTML = `<div class="isle-header"><span class="isle-label" style="color:${escHtml(src.labelColor)}">${escHtml(name)}</span></div>`;

      const body = document.createElement('div');
      body.className = 'isle-body';

      const isle = {
        id, label: name,
        color: src.color, shelfColor: src.shelfColor,
        fillColor: src.fillColor, fillOpacity: src.fillOpacity,
        labelColor: src.labelColor, rotation: src.rotation,
        facing: src.facing,
        position: { x, y }, dimensions: { ...src.dimensions },
        element: el,
        shelfCount: src.shelfLabels.length, shelfLabels: [...src.shelfLabels],
        subsectionStart: src.subsectionStart, subsectionCount: src.subsectionCount,
        subsections: [], createdAt: new Date().toISOString(),
      };

      src.subsections.forEach(srcSub => {
        const subId  = ++subsectionCounter;
        const subEl  = document.createElement('div');
        subEl.className = `subsection facing-${src.facing}`;
        subEl.dataset.subsectionNum = srcSub.number;

        const subNumEl = document.createElement('div');
        subNumEl.className = 'sub-number';
        subNumEl.textContent = srcSub.number;
        subEl.appendChild(subNumEl);

        const shelvesDiv = document.createElement('div');
        shelvesDiv.className = 'sub-shelves';
        const wallEl = document.createElement('div');
        wallEl.className = 'wall-indicator';

        const shelves = srcSub.shelves.map(srcSh => ({
          id: ++shelfCounter, isleId: id, subsectionId: subId,
          shelfNumber: srcSh.shelfNumber, label: srcSh.label,
          items: [], element: null,
        }));

        const makeSlot = (shelf) => {
          const slot = document.createElement('div');
          slot.className = 'shelf-slot';
          slot.textContent = shelf.label;
          slot.style.borderColor = src.shelfColor;
          shelf.element = slot;
          return slot;
        };

        if (src.facing === 'left') {
          [...shelves].reverse().forEach(sh => shelvesDiv.appendChild(makeSlot(sh)));
          shelvesDiv.appendChild(wallEl);
        } else {
          shelvesDiv.appendChild(wallEl);
          shelves.forEach(sh => shelvesDiv.appendChild(makeSlot(sh)));
        }
        subEl.appendChild(shelvesDiv);

        const subObj = { id: subId, isleId: id, number: srcSub.number, element: subEl, shelves };
        isle.subsections.push(subObj);

        subEl.addEventListener('click', (ev) => {
          ev.stopPropagation();
          if (drawMode || editMode || isleDragMoved) return;
          activeIsle       = isles.find(i => i.id === id);
          activeSubsection = subObj;
          openShelfSelect(subObj);
        });

        body.appendChild(subEl);
      });

      el.appendChild(body);
      applyIsleFill(el, src.fillColor, src.fillOpacity);
      warehouse.appendChild(el);
      isles.push(isle);
      attachIsleClickHandler(isle);
      if (editMode) createHandlesForEntity(isle, 'isle');

      countEl.textContent = `Isles: ${isles.length}`;
      statusEl.textContent = `Isle "${name}" pasted.`;
      hide('modal-paste-isle');
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       BACKGROUND IMAGE
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    let warehouseBg = null; // base64 data URL or null

    function setWarehouseBackground(dataUrl) {
      warehouseBg = dataUrl;
      Object.assign(warehouse.style, {
        backgroundImage:    `url(${dataUrl})`,
        backgroundSize:     'cover',
        backgroundPosition: 'center',
        backgroundRepeat:   'no-repeat',
      });
      document.getElementById('btn-clear-bg').style.display = '';
      statusEl.textContent = 'Background image set.';
    }

    function clearBackground() {
      warehouseBg = null;
      warehouse.style.backgroundImage = '';
      document.getElementById('btn-clear-bg').style.display = 'none';
      statusEl.textContent = 'Background cleared.';
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       MULTI-WAREHOUSE MANAGEMENT
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    function serializeCurrentWarehouse() {
      const wh = warehouses[activeWarehouseIdx];
      if (!wh) return;
      wh.width      = parseFloat(warehouse.style.width)  || warehouse.clientWidth;
      wh.height     = parseFloat(warehouse.style.height) || warehouse.clientHeight;
      wh.background = warehouseBg;
      wh.counters   = { isleCounter, subsectionCounter, shelfCounter, itemCounter, zoneCounter };
      wh.isles = isles.map(isle => ({
        id: isle.id, label: isle.label, color: isle.color, shelfColor: isle.shelfColor,
        fillColor: isle.fillColor || '#ffffff',
        fillOpacity: isle.fillOpacity != null ? isle.fillOpacity : 0,
        labelColor: isle.labelColor || isle.color,
        rotation: isle.rotation || 0,
        facing: isle.facing,
        position: { ...isle.position }, dimensions: { ...isle.dimensions },
        shelfCount: isle.shelfCount, shelfLabels: [...isle.shelfLabels],
        subsectionStart: isle.subsectionStart, subsectionCount: isle.subsectionCount,
        createdAt: isle.createdAt,
        subsections: isle.subsections.map(sub => ({
          id: sub.id, number: sub.number,
          shelves: sub.shelves.map(shelf => ({
            id: shelf.id, shelfNumber: shelf.shelfNumber, label: shelf.label,
            items: shelf.items.map(item => ({ ...item })),
          })),
        })),
      }));
      wh.zones = zones.map(zone => ({
        id: zone.id, label: zone.label, color: zone.color,
        fillOpacity: zone.fillOpacity != null ? zone.fillOpacity : 18,
        labelColor: zone.labelColor || '#444444',
        rotation: zone.rotation || 0,
        position: { ...zone.position }, dimensions: { ...zone.dimensions },
        items: (zone.items || []).map(item => ({ ...item })),
        createdAt: zone.createdAt,
      }));
    }

    function loadWarehouseDOM(wh) {
      importLayout({
        warehouse: { width: wh.width || 800, height: wh.height || 500, background: wh.background || null },
        counters:  wh.counters || {},
        isles:     wh.isles   || [],
        zones:     wh.zones   || [],
      });
      statusEl.textContent = `${escHtml(wh.name)} ‚Äî ${isles.length} isle(s), ${zones.length} zone(s).`;
    }

    function switchToWarehouse(idx) {
      if (idx === activeWarehouseIdx) return;
      serializeCurrentWarehouse();
      activeWarehouseIdx = idx;
      loadWarehouseDOM(warehouses[idx]);
      renderTabs();
    }

    function addWarehouse() {
      serializeCurrentWarehouse();
      const id = ++warehouseTabCounter;
      warehouses.push({
        id, name: `Warehouse ${warehouses.length + 1}`,
        width: 800, height: 500, background: null,
        counters: { isleCounter: 0, subsectionCounter: 0, shelfCounter: 0, itemCounter: 0, zoneCounter: 0 },
        isles: [], zones: [],
      });
      activeWarehouseIdx = warehouses.length - 1;
      loadWarehouseDOM(warehouses[activeWarehouseIdx]);
      renderTabs();
    }

    function removeWarehouse(idx) {
      if (warehouses.length <= 1) return;
      serializeCurrentWarehouse();
      warehouses.splice(idx, 1);
      if (idx < activeWarehouseIdx) {
        activeWarehouseIdx--;
        renderTabs();
      } else if (idx === activeWarehouseIdx) {
        activeWarehouseIdx = Math.min(idx, warehouses.length - 1);
        loadWarehouseDOM(warehouses[activeWarehouseIdx]);
        renderTabs();
      } else {
        renderTabs();
      }
    }

    function renderTabs() {
      const bar = document.getElementById('tab-bar');
      bar.innerHTML = '';
      warehouses.forEach((wh, idx) => {
        const tab = document.createElement('div');
        tab.className = 'tab' + (idx === activeWarehouseIdx ? ' active' : '');
        tab.title = 'Double-click to rename';

        const nameSpan = document.createElement('span');
        nameSpan.textContent = wh.name;
        tab.appendChild(nameSpan);

        if (warehouses.length > 1) {
          const closeBtn = document.createElement('button');
          closeBtn.className = 'tab-close';
          closeBtn.innerHTML = '&#x2715;';
          closeBtn.title = 'Close this warehouse';
          closeBtn.addEventListener('click', (e) => { e.stopPropagation(); removeWarehouse(idx); });
          tab.appendChild(closeBtn);
        }

        tab.addEventListener('click', () => { if (idx !== activeWarehouseIdx) switchToWarehouse(idx); });
        tab.addEventListener('dblclick', (e) => { e.stopPropagation(); renameWarehouseStart(idx, tab, nameSpan); });
        bar.appendChild(tab);
      });

      const addBtn = document.createElement('button');
      addBtn.className = 'btn-add-tab';
      addBtn.title = 'Add new warehouse';
      addBtn.textContent = '+';
      addBtn.addEventListener('click', addWarehouse);
      bar.appendChild(addBtn);
    }

    function renameWarehouseStart(idx, tab, nameSpan) {
      const input = document.createElement('input');
      input.type = 'text';
      input.className = 'tab-name-input';
      input.value = warehouses[idx].name;
      tab.replaceChild(input, nameSpan);
      input.focus(); input.select();

      const commit = () => {
        const newName = input.value.trim() || warehouses[idx].name;
        warehouses[idx].name = newName;
        renderTabs();
      };
      input.addEventListener('blur', commit);
      input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { e.preventDefault(); input.blur(); }
        if (e.key === 'Escape') { input.removeEventListener('blur', commit); renderTabs(); }
      });
    }

    // Drag-and-drop an image onto the viewport to set warehouse background
    viewport.addEventListener('dragover', (e) => {
      if (!e.dataTransfer.types.includes('Files')) return;
      e.preventDefault();
      warehouse.classList.add('drag-over');
    });
    viewport.addEventListener('dragleave', (e) => {
      if (!viewport.contains(e.relatedTarget)) warehouse.classList.remove('drag-over');
    });
    viewport.addEventListener('drop', (e) => {
      e.preventDefault();
      warehouse.classList.remove('drag-over');
      const file = [...e.dataTransfer.files].find(f => /^image\/(png|jpeg)$/.test(f.type));
      if (!file) { statusEl.textContent = 'Only PNG or JPG images are supported.'; return; }
      const reader = new FileReader();
      reader.onload = (ev) => setWarehouseBackground(ev.target.result);
      reader.readAsDataURL(file);
    });
    // Prevent browser navigation when files are dropped outside the viewport
    document.addEventListener('dragover', (e) => e.preventDefault());
    document.addEventListener('drop',     (e) => e.preventDefault());

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       EXPORT / IMPORT
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    function exportLayout() {
      serializeCurrentWarehouse();
      const data = {
        version:            2,
        exportedAt:         new Date().toISOString(),
        activeWarehouseIdx: activeWarehouseIdx,
        warehouses:         warehouses.map(wh => ({ ...wh })),
      };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href     = url;
      a.download = `warehouse-${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      statusEl.textContent = 'Layout saved.';
    }

    let pendingImportData = null;

    function triggerImport() {
      document.getElementById('import-file-input').click();
    }

    function handleImportFile(input) {
      const file = input.files[0];
      if (!file) return;
      input.value = '';
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const data = JSON.parse(ev.target.result);
          if (data.version === 2 && Array.isArray(data.warehouses)) {
            // v2: multi-warehouse format
            pendingImportData = data;
          } else if (data.warehouse && Array.isArray(data.isles)) {
            // v1: single warehouse ‚Äî wrap into v2 structure
            pendingImportData = {
              version: 2,
              activeWarehouseIdx: 0,
              warehouses: [{
                id: 1, name: 'Warehouse 1',
                width:      data.warehouse.width      || 800,
                height:     data.warehouse.height     || 500,
                background: data.warehouse.background || null,
                counters:   data.counters             || {},
                isles:      data.isles                || [],
                zones:      data.zones                || [],
              }],
            };
          } else {
            throw new Error('Invalid layout file.');
          }
          const isEmpty = warehouses.length === 1 && isles.length === 0 && zones.length === 0;
          if (isEmpty) confirmImport();
          else show('modal-confirm-import');
        } catch (err) {
          statusEl.textContent = `Import failed: ${err.message}`;
        }
      };
      reader.readAsText(file);
    }

    function confirmImport() {
      hide('modal-confirm-import');
      if (!pendingImportData) return;
      importAllWarehouses(pendingImportData);
      pendingImportData = null;
    }

    function importAllWarehouses(data) {
      // data is always v2 format at this point
      warehouses.length = 0;
      warehouseTabCounter = 0;
      (data.warehouses || []).forEach(wh => {
        const id = wh.id || ++warehouseTabCounter;
        if (id > warehouseTabCounter) warehouseTabCounter = id;
        warehouses.push({
          id,
          name:       wh.name       || `Warehouse ${warehouses.length + 1}`,
          width:      wh.width      || 800,
          height:     wh.height     || 500,
          background: wh.background || null,
          counters:   wh.counters   || {},
          isles:      wh.isles      || [],
          zones:      wh.zones      || [],
        });
      });
      if (warehouses.length === 0) {
        warehouses.push({ id: ++warehouseTabCounter, name: 'Warehouse 1',
          width: 800, height: 500, background: null,
          counters: {}, isles: [], zones: [] });
      }
      activeWarehouseIdx = Math.min(data.activeWarehouseIdx || 0, warehouses.length - 1);
      loadWarehouseDOM(warehouses[activeWarehouseIdx]);
      renderTabs();
    }

    function rebuildIsleFromData(isleData) {
      const { id, label, color, shelfColor, facing, position, dimensions,
              shelfLabels, subsectionStart, subsectionCount, createdAt } = isleData;
      const sc          = shelfColor || '#aaaaaa';
      const fillColor   = isleData.fillColor   || '#ffffff';
      const fillOpacity = isleData.fillOpacity != null ? isleData.fillOpacity : 0;
      const labelColor  = isleData.labelColor  || color;
      const rotation    = isleData.rotation    || 0;

      const el = document.createElement('div');
      el.className = 'isle';
      Object.assign(el.style, {
        left: `${position.x}px`, top: `${position.y}px`,
        width: `${dimensions.width}px`, height: `${dimensions.height}px`,
        borderColor: color,
        transform: `rotate(${rotation}deg)`,
      });
      el.dataset.isleId = id;
      el.innerHTML = `<div class="isle-header"><span class="isle-label" style="color:${escHtml(labelColor)}">${escHtml(label)}</span></div>`;

      const body = document.createElement('div');
      body.className = 'isle-body';

      const isle = {
        id, label, color, shelfColor: sc, fillColor, fillOpacity, labelColor, rotation, facing,
        position: { ...position }, dimensions: { ...dimensions },
        element: el, shelfCount: shelfLabels.length, shelfLabels: [...shelfLabels],
        subsectionStart, subsectionCount, subsections: [], createdAt,
      };

      (isleData.subsections || []).forEach(subData => {
        const subEl = document.createElement('div');
        subEl.className = `subsection facing-${facing}`;
        subEl.dataset.subsectionNum = subData.number;

        const subNumEl = document.createElement('div');
        subNumEl.className = 'sub-number';
        subNumEl.textContent = subData.number;
        subEl.appendChild(subNumEl);

        const shelvesDiv = document.createElement('div');
        shelvesDiv.className = 'sub-shelves';

        const wallEl = document.createElement('div');
        wallEl.className = 'wall-indicator';

        const shelves = (subData.shelves || []).map(shelfData => ({
          id:           shelfData.id,
          isleId:       id,
          subsectionId: subData.id,
          shelfNumber:  shelfData.shelfNumber,
          label:        shelfData.label,
          items:        (shelfData.items || []).map(item => ({ ...item })),
          element:      null,
        }));

        const makeSlot = (shelf) => {
          const slot = document.createElement('div');
          slot.className = 'shelf-slot';
          slot.textContent = shelf.label;
          slot.style.borderColor = sc;
          shelf.element = slot;
          return slot;
        };

        if (facing === 'left') {
          [...shelves].reverse().forEach(shelf => shelvesDiv.appendChild(makeSlot(shelf)));
          shelvesDiv.appendChild(wallEl);
        } else {
          shelvesDiv.appendChild(wallEl);
          shelves.forEach(shelf => shelvesDiv.appendChild(makeSlot(shelf)));
        }
        subEl.appendChild(shelvesDiv);

        const subObj = { id: subData.id, isleId: id, number: subData.number, element: subEl, shelves };
        isle.subsections.push(subObj);

        subEl.addEventListener('click', (e) => {
          e.stopPropagation();
          if (drawMode || editMode || isleDragMoved) return;
          activeIsle       = isles.find(i => i.id === id);
          activeSubsection = subObj;
          openShelfSelect(subObj);
        });

        body.appendChild(subEl);
      });

      el.appendChild(body);
      applyIsleFill(el, fillColor, fillOpacity);
      warehouse.appendChild(el);
      isles.push(isle);
      attachIsleClickHandler(isle);
    }

    function rebuildZoneFromData(zoneData) {
      const { id, label, color, position, dimensions, createdAt } = zoneData;
      const fillOpacity = zoneData.fillOpacity != null ? zoneData.fillOpacity : 18;
      const labelColor  = zoneData.labelColor  || '#444444';
      const rotation    = zoneData.rotation    || 0;
      const el = document.createElement('div');
      el.className = 'zone';
      Object.assign(el.style, {
        left: `${position.x}px`, top: `${position.y}px`,
        width: `${dimensions.width}px`, height: `${dimensions.height}px`,
        borderColor: color,
        transform: `rotate(${rotation}deg)`,
      });
      applyZoneFill(el, color, fillOpacity);
      el.dataset.zoneId = id;
      const labelEl = document.createElement('div');
      labelEl.className = 'zone-label';
      labelEl.textContent = label;
      labelEl.style.color = labelColor;
      el.appendChild(labelEl);
      warehouse.appendChild(el);
      const items = (zoneData.items || []).map(item => ({ ...item }));
      const zone = { id, label, color, fillOpacity, labelColor, rotation,
                     position: { ...position }, dimensions: { ...dimensions },
                     items, element: el, createdAt };
      zones.push(zone);
      attachZoneHandlers(zone);
    }

    function importLayout(data) {
      if (drawMode) cancelDrawMode();
      if (editMode) cancelEditMode();
      closeAllModals();

      isles.forEach(isle => isle.element.remove());
      isles.length = 0;
      zones.forEach(zone => zone.element.remove());
      zones.length = 0;
      removeEditHandles();

      warehouse.style.width  = data.warehouse.width  + 'px';
      warehouse.style.height = data.warehouse.height + 'px';

      if (data.warehouse.background) {
        setWarehouseBackground(data.warehouse.background);
      } else {
        clearBackground();
      }

      const c = data.counters || {};
      isleCounter       = c.isleCounter       || 0;
      subsectionCounter = c.subsectionCounter || 0;
      shelfCounter      = c.shelfCounter      || 0;
      itemCounter       = c.itemCounter       || 0;
      zoneCounter       = c.zoneCounter       || 0;

      (data.isles || []).forEach(rebuildIsleFromData);
      (data.zones || []).forEach(rebuildZoneFromData);

      countEl.textContent = `Isles: ${isles.length}`;
      statusEl.textContent = `Loaded: ${isles.length} isle(s), ${zones.length} zone(s).`;
      resetView();
    }

    window.isles = isles;
  </script>

</body>
</html>
