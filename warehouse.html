<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>IndSurp ‚Äî Warehouse Layout</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="warehouse.css">
  <!-- Critical layout ‚Äî inlined to bypass any CSS-file caching issues -->
  <style>
    html, body { margin: 0; padding: 0; }
    #app { display: flex !important; flex-direction: column !important; height: 100vh !important; overflow: hidden !important; }
  </style>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
</head>
<body>

<div id="app">

  <!-- ‚îÄ‚îÄ App Header: search + brand ‚îÄ‚îÄ -->
  <header class="app-header">
    <div class="search-bar">
      <div class="search-input-wrap">
        <input type="text" v-model="searchQuery" placeholder="Search by Item ID..." autocomplete="off"
               @input="onSearchInput" @keydown.enter="runSearch" />
        <button class="btn-search" @click="runSearch">Search</button>
        <button class="btn-clear-search" v-show="showSearchResults" @click="clearSearch">Clear</button>
      </div>
    </div>
    <div class="brand-name">IndSurp</div>
    <a class="btn-search-page" href="/search" target="_blank">Item Search</a>
    <div class="user-info">
      <span class="user-role-badge" :class="userData.role">{{ userData.role }}</span>
      <span class="user-name">{{ userData.username }}</span>
      <button class="btn-logout" @click="logout">Sign Out</button>
    </div>
  </header>

  <!-- ‚îÄ‚îÄ Main content ‚îÄ‚îÄ -->
  <main class="app-main">
    <div class="warehouse-panel">
      <!-- Tab bar -->
      <div class="tab-bar">
        <div v-for="(wh, idx) in tabs" :key="wh.id"
             class="tab" :class="{ active: idx === activeTabIdx }"
             @click="switchTab(idx)" @dblclick.stop="isAdmin && startRenameTab(idx, $event)">
          <span v-if="renamingTabIdx !== idx">{{ wh.name }}</span>
          <input v-else type="text" class="tab-name-input" :value="wh.name"
                 @blur="commitRenameTab(idx, $event)"
                 @keydown.enter.prevent="$event.target.blur()"
                 @keydown.escape="cancelRenameTab(idx)"
                 ref="tabNameInput">
          <button v-if="isAdmin && tabs.length > 1" class="tab-close" @click.stop="removeTab(idx)">&#x2715;</button>
        </div>
        <button v-if="isAdmin" class="btn-add-tab" title="Add new warehouse" @click="addTab">+</button>
      </div>

      <!-- Viewport -->
      <div class="viewport" ref="viewport">
        <div class="pan-zoom-layer" ref="panZoomLayer">
          <div class="warehouse-wrapper" ref="warehouseWrapper" :class="{ 'edit-mode': editActive }">
            <div class="warehouse" ref="warehouse">
              <div ref="drawPreview" class="draw-preview-el"></div>
            </div>
            <div v-for="edge in ['nw','n','ne','e','se','s','sw','w']" :key="edge"
                 v-show="isAdmin"
                 :class="`rh rh-${edge}`" :data-edge="edge"
                 @mousedown.stop.prevent="startWarehouseResize(edge, $event)">
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- ‚îÄ‚îÄ Floating side menu ‚îÄ‚îÄ -->
  <div class="floating-menu" :class="{ collapsed: menuCollapsed }">
    <button class="menu-toggle-tab" @click="menuCollapsed = !menuCollapsed" title="Toggle menu">
      {{ menuCollapsed ? '&#x2039;' : '&#x203A;' }}
    </button>
    <h3>Warehouse Tools</h3>
    <button v-if="isAdmin" class="btn-add-pallet-rack" :class="{ active: addPalletRackActive }" @click="activateDrawMode">Add Pallet Rack</button>
    <button v-if="isAdmin" class="btn-add-zone" :class="{ active: addZoneActive }" @click="activateZoneMode">Add Zone</button>
    <button v-if="isAdmin" class="btn-edit-warehouse" @click="activateEditMode">{{ editActive ? 'Finish Editing' : 'Edit Warehouse' }}</button>
    <button class="btn-delete-entity" v-show="isAdmin && showDelEntBtn" @click="deleteSelectedEntity">&#x1F5D1; Delete Selected</button>
    <hr style="border:none;border-top:1px solid #334155;margin:4px 0;">
    <button v-if="isAdmin" class="btn-add-bg" @click="triggerBgImport">Add Background</button>
    <button v-if="isAdmin" class="btn-clear-bg" v-show="hasBg" @click="clearBackground">Clear Background</button>
    <input v-if="isAdmin" type="file" ref="bgFileInput" accept="image/png,image/jpeg" style="display:none" @change="handleBgFile">
    <div class="status-msg">{{ statusText }}</div>
    <div class="pallet-rack-count">{{ palletRackCountText }}</div>

    <!-- Inspector panel ‚Äî shown when a pallet rack or zone is selected in edit mode -->
    <template v-if="insp_show">
      <hr style="border:none;border-top:1px solid #334155;margin:2px 0;">
      <div class="insp-panel">
        <div class="insp-title">{{ insp_type === 'pallet-rack' ? 'Pallet Rack' : 'Zone' }}</div>
        <div class="insp-field">
          <label class="insp-lbl">Name</label>
          <input class="insp-input" type="text" v-model="insp_name"
                 :style="insp_nameError ? 'border-color:#ef4444' : ''"
                 @keydown.enter="applyInspectorLabel" />
        </div>
        <div class="insp-field" v-if="insp_type === 'pallet-rack'">
          <label class="insp-lbl">Row</label>
          <input class="insp-input" type="text" v-model="insp_row"
                 @keydown.enter="applyInspectorLabel" />
        </div>
        <div class="insp-field">
          <label class="insp-lbl">Border color</label>
          <input type="color" v-model="insp_color" class="insp-color-pick"
                 @change="saveLayout" />
        </div>
        <div class="insp-field">
          <label class="insp-lbl">Label color</label>
          <input type="color" v-model="insp_labelColor" class="insp-color-pick"
                 @change="saveLayout" />
        </div>
        <div class="insp-field" v-if="insp_type === 'pallet-rack'">
          <label class="insp-lbl">Fill color</label>
          <input type="color" v-model="insp_fillColor" class="insp-color-pick"
                 @change="saveLayout" />
        </div>
        <div class="insp-field" v-if="insp_type === 'pallet-rack'">
          <label class="insp-lbl">Shelf Order</label>
          <div class="insp-facing-group">
            <button type="button" class="facing-opt" :class="{ selected: insp_shelfOrder === 'right' }"
                    @click="applyShelfOrder('right')">Left ‚Üí Right</button>
            <button type="button" class="facing-opt" :class="{ selected: insp_shelfOrder === 'left' }"
                    @click="applyShelfOrder('left')">Right ‚Üí Left</button>
          </div>
        </div>
        <div class="insp-field">
          <label class="insp-lbl">Opacity <span style="color:#94a3b8;font-weight:400;">{{ insp_fillOpacity }}%</span></label>
          <input type="range" v-model.number="insp_fillOpacity" min="0" max="100"
                 class="insp-range" @change="saveLayout" />
        </div>
        <label v-if="insp_type === 'pallet-rack'" class="insp-flag-label">
          <input type="checkbox" v-model="insp_hideHeader" class="insp-flag-cb" />
          Hide name &amp; row
        </label>
        <label v-if="insp_type === 'zone'" class="insp-flag-label">
          <input type="checkbox" v-model="insp_hideLabel" class="insp-flag-cb" @change="saveLayout" />
          Hide label
        </label>
        <label v-if="insp_type === 'zone'" class="insp-flag-label">
          <input type="checkbox" v-model="insp_itemFree" class="insp-flag-cb" @change="saveLayout" />
          Item-free
        </label>
        <button class="btn-insp-save" @click="applyInspectorLabel">Save Name</button>
      </div>
    </template>

    <!-- Nav: Pallet Racks -->
    <div class="nav-section" v-if="navPalletRacks.length > 0">
      <button class="nav-section-header" @click="navPROpen = !navPROpen">
        <span class="nav-section-icon">{{ navPROpen ? '‚ñæ' : '‚ñ∏' }}</span>
        Pallet Racks
        <span class="nav-section-count">{{ navPalletRacks.length }}</span>
      </button>
      <div v-show="navPROpen" class="nav-list">
        <div v-for="pr in navPalletRacks" :key="pr.warehouseIdx + '-' + pr.id" class="nav-item" @click="jumpToPalletRack(pr)">
          <span class="nav-item-label">{{ pr.label }}</span>
          <span v-if="pr.row || pr.whLabel" class="nav-item-meta">{{ [pr.row, pr.whLabel].filter(Boolean).join(' ¬∑ ') }}</span>
        </div>
      </div>
    </div>

    <!-- Nav: Zones -->
    <div class="nav-section" v-if="navZones.length > 0">
      <button class="nav-section-header" @click="navZonesOpen = !navZonesOpen">
        <span class="nav-section-icon">{{ navZonesOpen ? '‚ñæ' : '‚ñ∏' }}</span>
        Zones
        <span class="nav-section-count">{{ navZones.length }}</span>
      </button>
      <div v-show="navZonesOpen" class="nav-list">
        <div v-for="zone in navZones" :key="zone.warehouseIdx + '-' + zone.id" class="nav-item" @click="jumpToZone(zone)">
          <span class="nav-item-label">{{ zone.label }}</span>
          <span v-if="zone.whLabel" class="nav-item-meta">{{ zone.whLabel }}</span>
        </div>
      </div>
    </div>

    <div style="display:flex;gap:5px;margin-top:2px;">
      <button @click="zoomOut" title="Zoom Out" style="flex:1;padding:7px 4px;border:1px solid #334155;border-radius:6px;background:#0f172a;cursor:pointer;font-size:18px;font-weight:700;color:#94a3b8;line-height:1;">‚àí</button>
      <button @click="resetView" title="Reset View" style="flex:1;padding:7px 4px;border:1px solid #334155;border-radius:6px;background:#0f172a;cursor:pointer;font-size:13px;font-weight:700;color:#94a3b8;line-height:1;">‚åÇ</button>
      <button @click="zoomIn" title="Zoom In" style="flex:1;padding:7px 4px;border:1px solid #334155;border-radius:6px;background:#0f172a;cursor:pointer;font-size:18px;font-weight:700;color:#94a3b8;line-height:1;">+</button>
    </div>
    <div style="font-size:11px;color:#475569;text-align:center;">{{ zoomText }}</div>
  </div>

  <!-- ‚ïê‚ïê STEP 1: Pallet Rack name + shelves per subsection ‚ïê‚ïê -->
  <div class="modal-overlay" v-show="m_count">
    <div class="modal">
      <button class="modal-close" @click="cancelPalletRackCreation" title="Close">&#x2715;</button>
      <p class="modal-title">New Pallet Rack</p>
      <p class="modal-subtitle">Name this pallet rack and set how many shelves each subsection will have.</p>
      <div class="two-col">
        <div class="form-field" style="flex:0 0 80px">
          <label>Row</label>
          <input type="text" v-model="f_palletRackRow" placeholder="e.g. A" maxlength="10" />
        </div>
        <div class="form-field">
          <label>Pallet Rack Name <span style="color:#e53935">*</span></label>
          <input type="text" v-model="f_palletRackName" placeholder="e.g. Aisle 1, Electronics Row"
                 ref="palletRackNameInput" :style="palletRackNameError ? 'border-color:#e53935' : ''" />
        </div>
      </div>
      <div class="form-field">
        <label>Shelves per Subsection <span style="color:#888;font-weight:400">(max 26)</span></label>
        <input class="shelf-count-input" v-model.number="f_shelfCount" type="number" min="1" max="26" />
      </div>
      <div class="two-col">
        <div class="form-field">
          <label>Pallet Rack Border Color</label>
          <div class="color-pick-row">
            <input type="color" v-model="f_palletRackColor" />
            <span class="color-pick-hint">Pallet rack border</span>
          </div>
        </div>
        <div class="form-field">
          <label>Pallet Rack Name Color</label>
          <div class="color-pick-row">
            <input type="color" v-model="f_palletRackLabelColor" />
            <span class="color-pick-hint">Name label</span>
          </div>
        </div>
      </div>
      <div class="two-col">
        <div class="form-field">
          <label>Shelf Border Color</label>
          <div class="color-pick-row">
            <input type="color" v-model="f_shelfColor" />
            <span class="color-pick-hint">Shelf slot borders</span>
          </div>
        </div>
        <div class="form-field">
          <label>Pallet Rack Fill Color</label>
          <div class="color-pick-row">
            <input type="color" v-model="f_palletRackFillColor" />
            <span class="color-pick-hint">Inner fill</span>
          </div>
        </div>
      </div>
      <div class="form-field">
        <label>Pallet Rack Fill Opacity <span style="font-weight:400;color:#888;">{{ f_palletRackFillOpacity }}%</span></label>
        <input type="range" v-model.number="f_palletRackFillOpacity" min="0" max="100" style="width:100%;margin-top:4px;">
      </div>
      <div class="form-field">
        <label>Shelf Order</label>
        <div class="facing-group">
          <button type="button" class="facing-opt" :class="{ selected: f_palletRackFacing === 'right' }"
                  @click="f_palletRackFacing = 'right'">Left ‚Üí Right<br><span style="font-size:10px;font-weight:400;">First shelf on the left</span></button>
          <button type="button" class="facing-opt" :class="{ selected: f_palletRackFacing === 'left' }"
                  @click="f_palletRackFacing = 'left'">Right ‚Üí Left<br><span style="font-size:10px;font-weight:400;">First shelf on the right</span></button>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" @click="cancelPalletRackCreation">Cancel</button>
        <button class="btn-confirm" @click="confirmStep1">Next ‚Üí</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê STEP 2: Subsection config ‚ïê‚ïê -->
  <div class="modal-overlay" v-show="m_subs">
    <div class="modal">
      <button class="modal-close" @click="cancelPalletRackCreation" title="Close">&#x2715;</button>
      <p class="modal-title">{{ mc_subConfigTitle }}</p>
      <p class="modal-subtitle">Set how many subsections and where the numbering starts.</p>
      <div class="two-col">
        <div class="form-field">
          <label>Start Number</label>
          <input type="number" v-model.number="f_subStart" min="1" />
        </div>
        <div class="form-field">
          <label>Number of Subsections</label>
          <input type="number" v-model.number="f_subCount" min="1" />
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" @click="goBackToStep1">‚Üê Back</button>
        <button class="btn-confirm" @click="confirmStep2">Next ‚Üí</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê STEP 3: Label shelves ‚ïê‚ïê -->
  <div class="modal-overlay" v-show="m_labels">
    <div class="modal">
      <button class="modal-close" @click="cancelPalletRackCreation" title="Close">&#x2715;</button>
      <p class="modal-title">{{ mc_labelsTitle }}</p>
      <p class="modal-subtitle">These labels apply to every subsection in the pallet rack.</p>
      <div class="shelf-list">
        <div v-for="(shelf, idx) in f_shelfLabelsList" :key="idx" class="shelf-row">
          <span class="shelf-num">Shelf {{ idx + 1 }}</span>
          <input type="text" v-model="f_shelfLabelsList[idx].label" />
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" @click="goBackToStep2">‚Üê Back</button>
        <button class="btn-confirm" @click="confirmStep3">Confirm</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê Select subsection ‚ïê‚ïê -->
  <div class="modal-overlay" v-show="m_subSel">
    <div class="modal">
      <button class="modal-close" @click="closeAllModals" title="Close">&#x2715;</button>
      <p class="modal-title">{{ mc_subSelTitle }}</p>
      <p class="modal-subtitle">Click a subsection to manage its shelves.</p>
      <div class="select-list">
        <div v-for="sub in mc_subSelList" :key="sub.id" class="select-row" @click="selectSubsectionFromList(sub)">
          <span class="row-name">{{ sub.name || 'Subsection ' + sub.number }}</span>
          <span class="row-meta">{{ sub.shelves.length }} shelves ¬∑ {{ sub.totalItems }} items</span>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" @click="closeAllModals">Close</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê Select shelf ‚ïê‚ïê -->
  <div class="modal-overlay" v-show="m_shelfSel">
    <div class="modal">
      <button class="modal-close" @click="closeAllModals" title="Close">&#x2715;</button>
      <p class="modal-title">{{ mc_shelfSelTitle }}</p>
      <div class="form-field" v-if="isAdmin || f_subName" style="margin-bottom:8px;">
        <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;">
          <label style="margin:0;font-size:12px;color:#94a3b8;font-weight:500;">Subsection Name</label>
          <button v-if="isAdmin" class="btn-sub-unlock" @click="unlockSubName"
                  :disabled="!subNameLocked"
                  :title="subNameLocked ? 'Click to unlock and edit name' : 'Editing enabled'">
            {{ subNameLocked ? 'üîí' : 'üîì' }}
          </button>
        </div>
        <input type="text" v-model="f_subName" :disabled="subNameLocked"
               :style="subNameError ? 'border-color:#e53935' : ''"
               placeholder="Optional name..."
               @keydown.enter="saveSubName" ref="subNameInput" />
        <button v-if="isAdmin && !subNameLocked" class="btn-confirm"
                style="margin-top:6px;width:100%;" @click="saveSubName">Save Name</button>
      </div>
      <p class="modal-subtitle">Click a shelf to manage its items.</p>
      <div class="select-list">
        <div v-for="shelf in mc_shelfSelList" :key="shelf.id" class="select-row" @click="selectShelfFromList(shelf)">
          <span class="row-name">{{ shelf.label }}</span>
          <span class="row-meta">{{ shelf.items.length }} item{{ shelf.items.length !== 1 ? 's' : '' }}</span>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" @click="backToSubsectionSelect">‚Üê Back</button>
        <button v-if="isAdmin" class="btn-danger" @click="openDeleteSub">Delete Sub</button>
        <button v-if="isAdmin" class="btn-confirm" @click="openAddShelf">+ Add Shelf</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê Add shelf ‚ïê‚ïê -->
  <div class="modal-overlay" v-show="m_addShelf">
    <div class="modal">
      <button class="modal-close" @click="closeAllModals" title="Close">&#x2715;</button>
      <p class="modal-title">Add Shelf</p>
      <p class="modal-subtitle">{{ mc_addShelfSub }}</p>
      <div class="form-field">
        <label>Shelf Name <span style="color:#e53935">*</span></label>
        <input type="text" v-model="f_addShelfName" placeholder="e.g. D"
               :style="addShelfNameError ? 'border-color:#e53935' : ''" ref="addShelfInput" />
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" @click="backToShelfSelectFromAdd">‚Üê Back</button>
        <button class="btn-confirm" @click="confirmAddShelf">Add Shelf</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê Shelf actions ‚ïê‚ïê -->
  <div class="modal-overlay" v-show="m_shelfAct">
    <div class="modal">
      <button class="modal-close" @click="closeAllModals" title="Close">&#x2715;</button>
      <p class="modal-title">{{ mc_shelfActTitle }}</p>
      <p class="modal-subtitle">{{ mc_shelfActSub }}</p>
      <div class="form-field" style="margin-bottom:8px;">
        <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;">
          <label style="margin:0;font-size:12px;color:#94a3b8;font-weight:500;">Shelf Label</label>
          <button v-if="isAdmin" class="btn-sub-unlock" @click="unlockShelfName"
                  :disabled="!shelfNameLocked"
                  :title="shelfNameLocked ? 'Click to unlock and edit label' : 'Editing enabled'">
            {{ shelfNameLocked ? 'üîí' : 'üîì' }}
          </button>
        </div>
        <input type="text" v-model="f_shelfActName" :disabled="shelfNameLocked"
               :style="shelfActNameError ? 'border-color:#e53935' : ''"
               @keydown.enter="saveShelfName" ref="shelfNameInput" />
        <button v-if="isAdmin && !shelfNameLocked" class="btn-confirm"
                style="margin-top:6px;width:100%;" @click="saveShelfName">Save Label</button>
      </div>
      <div class="action-btn-group">
        <button class="action-btn view" @click="openViewItems">
          <span class="action-icon">‚ò∞</span>View Items
        </button>
        <button class="action-btn add" @click="openAddItem">
          <span class="action-icon">Ôºã</span>Add Item
        </button>
        <button class="action-btn bulk" @click="openBulkAdd">
          <span class="action-icon">‚äû</span>Bulk Add
        </button>
        <button class="action-btn rem" @click="openRemoveItems">
          <span class="action-icon">Ôºç</span>Remove Item
        </button>
        <button v-if="isAdmin" class="action-btn del" @click="deleteShelf">
          <span class="action-icon">üóë</span>Delete Shelf
        </button>
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" @click="backToShelfSelect">‚Üê Back</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê Add item ‚ïê‚ïê -->
  <div class="modal-overlay" v-show="m_addItem">
    <div class="modal">
      <button class="modal-close" @click="closeAllModals" title="Close">&#x2715;</button>
      <p class="modal-title">Add Item</p>
      <p class="modal-subtitle">{{ mc_addItemSub }}</p>
      <div class="form-field">
        <label>Item ID <span style="color:#e53935">*</span></label>
        <input type="text" v-model="f_itemId" placeholder="e.g. SKU-00123"
               :style="itemIdError ? 'border-color:#e53935' : ''" ref="itemIdInput" />
      </div>
      <div class="form-field">
        <label>Item Type</label>
        <input type="text" v-model="f_itemType" placeholder="e.g. Electronics" />
      </div>
      <div class="form-field">
        <label>Item Category</label>
        <input type="text" v-model="f_itemCategory" placeholder="e.g. Accessories" />
      </div>
      <div class="form-field">
        <label>Tags <span style="color:#64748b;font-weight:400">(comma-separated)</span></label>
        <input type="text" v-model="f_itemTags" placeholder="e.g. fragile, priority, hazmat" />
      </div>
      <div class="form-field">
        <label>URL <span style="color:#64748b;font-weight:400">(optional)</span></label>
        <input type="url" v-model="f_itemUrl" placeholder="https://..." />
      </div>
      <div class="form-field">
        <label>Notes</label>
        <textarea v-model="f_itemNotes" placeholder="Any additional notes..."></textarea>
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" @click="backFromAddItem">‚Üê Back</button>
        <button class="btn-confirm" @click="confirmAddItem">Add Item</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê Bulk add items ‚ïê‚ïê -->
  <div class="modal-overlay" v-show="m_bulkAdd">
    <div class="modal">
      <button class="modal-close" @click="closeAllModals" title="Close">&#x2715;</button>
      <p class="modal-title">Bulk Add Items</p>
      <p class="modal-subtitle">{{ mc_addItemSub }}</p>
      <p style="font-size:11px;color:#64748b;margin:0 0 6px;">
        One item per line: <code style="color:#94a3b8;">ID;Type;Category;Tags;URL;Notes</code>
      </p>
      <div class="form-field">
        <textarea ref="bulkAddInput" v-model="f_bulkText" rows="8"
                  placeholder="1234;electronics;accessories;fragile,hazmat;https://example.com;notes here&#10;4321;plumbing;fittings;;;another note"
                  style="font-family:monospace;font-size:12px;resize:vertical;"></textarea>
      </div>
      <p v-if="bulkAddError" style="color:#ef4444;font-size:12px;white-space:pre-line;margin:4px 0 0;">{{ bulkAddError }}</p>
      <div class="modal-actions">
        <button class="btn-cancel" @click="m_bulkAdd = false; m_shelfAct = true">‚Üê Back</button>
        <button class="btn-confirm" @click="confirmBulkAdd">Add Items</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê View items ‚ïê‚ïê -->
  <div class="modal-overlay" v-show="m_viewItems">
    <div class="modal">
      <button class="modal-close" @click="closeAllModals" title="Close">&#x2715;</button>
      <p class="modal-title">{{ mc_shelfActTitle }}</p>
      <p class="modal-subtitle">{{ mc_itemList.length }} item{{ mc_itemList.length !== 1 ? 's' : '' }}</p>
      <div class="item-list">
        <p v-if="mc_itemList.length === 0" class="no-items-msg">No items on this shelf.</p>
        <div v-for="item in mc_itemList" :key="item.id" class="item-row view-row"
             @click="openItemDetail(item)">
          <div class="view-row-main">
            <span class="item-id-label">{{ item.itemId }}</span>
            <span class="item-meta">{{ [item.type, item.category].filter(Boolean).join(' ¬∑ ') || '‚Äî' }}</span>
          </div>
          <div class="item-tooltip">
            <div><strong>ID:</strong> {{ item.itemId }}</div>
            <div v-if="item.type"><strong>Type:</strong> {{ item.type }}</div>
            <div v-if="item.category"><strong>Category:</strong> {{ item.category }}</div>
            <div v-if="item.tags"><strong>Tags:</strong> {{ item.tags }}</div>
            <div v-if="item.url"><strong>URL:</strong> {{ item.url }}</div>
            <div v-if="item.notes"><strong>Notes:</strong> {{ item.notes }}</div>
            <div v-if="item.addedAt"><strong>Added:</strong> {{ new Date(item.addedAt).toLocaleDateString() }}</div>
          </div>
        </div>
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" @click="m_viewItems = false; m_shelfAct = true">‚Üê Back</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê Item detail ‚ïê‚ïê -->
  <div class="modal-overlay" v-show="m_itemDetail && mc_activeItem">
    <div class="modal" v-if="mc_activeItem">
      <button class="modal-close" @click="m_itemDetail = false" title="Close">&#x2715;</button>
      <p class="modal-title">{{ mc_activeItem.itemId }}</p>
      <div class="item-detail-grid">
        <template v-if="mc_activeItem.type">
          <span class="detail-lbl">Type</span><span class="detail-val">{{ mc_activeItem.type }}</span>
        </template>
        <template v-if="mc_activeItem.category">
          <span class="detail-lbl">Category</span><span class="detail-val">{{ mc_activeItem.category }}</span>
        </template>
        <template v-if="mc_activeItem.tags">
          <span class="detail-lbl">Tags</span><span class="detail-val">{{ mc_activeItem.tags }}</span>
        </template>
        <template v-if="mc_activeItem.url">
          <span class="detail-lbl">URL</span>
          <span class="detail-val"><a :href="mc_activeItem.url" target="_blank" rel="noopener noreferrer">{{ mc_activeItem.url }}</a></span>
        </template>
        <template v-if="mc_activeItem.notes">
          <span class="detail-lbl">Notes</span><span class="detail-val">{{ mc_activeItem.notes }}</span>
        </template>
        <template v-if="mc_activeItem.addedAt">
          <span class="detail-lbl">Added</span><span class="detail-val">{{ new Date(mc_activeItem.addedAt).toLocaleString() }}</span>
        </template>
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" @click="m_itemDetail = false">‚Üê Back</button>
        <button class="btn-danger" @click="deleteViewItem">Delete Item</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê Zone label modal ‚ïê‚ïê -->
  <div class="modal-overlay" v-show="m_zone">
    <div class="modal">
      <button class="modal-close" @click="cancelZoneCreation" title="Close">&#x2715;</button>
      <p class="modal-title">New Zone</p>
      <p class="modal-subtitle">Label this area of the warehouse.</p>
      <div class="form-field">
        <label>Zone Label <span style="color:#e53935">*</span></label>
        <input type="text" v-model="f_zoneLabel" placeholder="e.g. Receiving, Break Room, Staging"
               :style="zoneLabelError ? 'border-color:#e53935' : ''" ref="zoneLabelInput" />
      </div>
      <div class="two-col">
        <div class="form-field">
          <label>Zone Border Color</label>
          <div class="color-pick-row">
            <input type="color" v-model="f_zoneColor" />
            <span class="color-pick-hint">Border &amp; fill</span>
          </div>
        </div>
        <div class="form-field">
          <label>Zone Name Color</label>
          <div class="color-pick-row">
            <input type="color" v-model="f_zoneNameColor" />
            <span class="color-pick-hint">Label text</span>
          </div>
        </div>
      </div>
      <div class="form-field">
        <label>Fill Opacity <span style="font-weight:400;color:#888;">{{ f_zoneFillOpacity }}%</span></label>
        <input type="range" v-model.number="f_zoneFillOpacity" min="0" max="100" style="width:100%;margin-top:4px;">
      </div>
      <div class="two-col">
        <label class="zone-flag-label">
          <input type="checkbox" v-model="f_zoneHideLabel" class="zone-flag-cb" />
          Hide label
        </label>
        <label class="zone-flag-label">
          <input type="checkbox" v-model="f_zoneItemFree" class="zone-flag-cb" />
          Item-free
        </label>
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" @click="cancelZoneCreation">Cancel</button>
        <button class="btn-confirm" @click="confirmZone">Create Zone</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê Confirm delete shelf ‚ïê‚ïê -->
  <div class="modal-overlay" v-show="m_confDel">
    <div class="modal">
      <p class="modal-title">Delete Shelf?</p>
      <p class="modal-subtitle">{{ mc_confDelMsg }}</p>
      <div class="modal-actions">
        <button class="btn-cancel" @click="m_confDel = false">No, Keep It</button>
        <button class="btn-danger" v-show="mc_showDelBtn" @click="confirmDeleteShelf">Yes, Delete</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê Confirm delete subsection ‚ïê‚ïê -->
  <div class="modal-overlay" v-show="m_confDelSub">
    <div class="modal">
      <p class="modal-title">Delete Subsection?</p>
      <p class="modal-subtitle">{{ mc_confDelSubMsg }}</p>
      <div class="modal-actions">
        <button class="btn-cancel" @click="m_confDelSub = false">No, Keep It</button>
        <button class="btn-danger" @click="confirmDeleteSub">Yes, Delete</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê Paste pallet rack ‚ïê‚ïê -->
  <div class="modal-overlay" v-show="m_pastePalletRack">
    <div class="modal">
      <button class="modal-close" @click="m_pastePalletRack = false" title="Close">&#x2715;</button>
      <p class="modal-title">Paste Pallet Rack</p>
      <p class="modal-subtitle">{{ mc_pastePalletRackSub }}</p>
      <div class="form-field">
        <label>New Pallet Rack Name <span style="color:#e53935">*</span></label>
        <input type="text" v-model="f_pastePalletRackName" placeholder="Enter a name for the pasted pallet rack"
               :style="pastePalletRackNameError ? 'border-color:#e53935' : ''" ref="pastePalletRackInput" />
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" @click="m_pastePalletRack = false">Cancel</button>
        <button class="btn-confirm" @click="pastePalletRack">Paste</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê Paste zone ‚ïê‚ïê -->
  <div class="modal-overlay" v-show="m_pasteZone">
    <div class="modal">
      <button class="modal-close" @click="m_pasteZone = false" title="Close">&#x2715;</button>
      <p class="modal-title">Paste Zone</p>
      <p class="modal-subtitle">{{ mc_pasteZoneSub }}</p>
      <div class="form-field">
        <label>New Zone Label <span style="color:#e53935">*</span></label>
        <input type="text" v-model="f_pasteZoneName" placeholder="Enter a label for the pasted zone"
               :style="pasteZoneNameError ? 'border-color:#e53935' : ''" ref="pasteZoneInput"
               @keydown.enter="pasteZone" />
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" @click="m_pasteZone = false">Cancel</button>
        <button class="btn-confirm" @click="pasteZone">Paste</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê Delete pallet rack / zone ‚ïê‚ïê -->
  <div class="modal-overlay" v-show="m_delEnt">
    <div class="modal">
      <p class="modal-title">{{ mc_delEntTitle }}</p>
      <p class="modal-subtitle">{{ mc_delEntMsg }}</p>
      <div class="modal-actions">
        <button class="btn-cancel" @click="m_delEnt = false">Cancel</button>
        <button class="btn-danger" @click="confirmDeleteEntity">Yes, Delete</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê Remove items ‚ïê‚ïê -->
  <div class="modal-overlay" v-show="m_rmItems">
    <div class="modal">
      <button class="modal-close" @click="closeAllModals" title="Close">&#x2715;</button>
      <p class="modal-title">{{ mc_rmItemsTitle }}</p>
      <p class="modal-subtitle">Click to select ¬∑ Ctrl+Click for multiple</p>
      <div class="item-list">
        <p v-if="mc_itemList.length === 0" class="no-items-msg">No items on this shelf.</p>
        <div v-for="item in mc_itemList" :key="item.id"
             class="item-row" :class="{ selected: mc_selItemIds.includes(item.id) }"
             @click="toggleItemSel(item.id, $event.ctrlKey || $event.metaKey)">
          <span class="item-id-label">{{ item.itemId }}</span>
          <span class="item-meta">{{ [item.type, item.category].filter(Boolean).join(' ¬∑ ') }}</span>
          <span v-if="item.notes" class="item-meta" style="font-style:italic">{{ item.notes }}</span>
        </div>
      </div>
      <div class="selected-count">{{ mc_selCount }} selected</div>
      <div class="modal-actions">
        <button class="btn-cancel" @click="backToShelfActions">‚Üê Back</button>
        <button class="btn-move" :disabled="mc_selCount === 0" @click="openMoveItems">Move Selected</button>
        <button class="btn-danger" :disabled="mc_selCount === 0" @click="confirmRemoveItems">Remove Selected</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê Move items: destination picker ‚ïê‚ïê -->
  <div class="modal-overlay" v-show="m_moveDest">
    <div class="modal">
      <button class="modal-close" @click="closeAllModals" title="Close">&#x2715;</button>
      <p class="modal-title">Move {{ mc_selCount }} Item{{ mc_selCount !== 1 ? 's' : '' }}</p>
      <p class="modal-subtitle" style="margin-bottom:4px">From: {{ mv_srcLabel }}</p>
      <p class="modal-subtitle" v-if="mv_step === 'pallet-rack'">Select destination pallet rack</p>
      <p class="modal-subtitle" v-if="mv_step === 'sub'">Select destination subsection</p>
      <p class="modal-subtitle" v-if="mv_step === 'shelf'">Select destination shelf</p>

      <!-- Step 1: pallet rack list -->
      <div class="select-list" v-if="mv_step === 'pallet-rack'">
        <p v-if="mv_palletRacks.length === 0" class="no-items-msg">No pallet racks in this warehouse.</p>
        <div v-for="palletRack in mv_palletRacks" :key="palletRack.id" class="select-row" @click="mvPickPalletRack(palletRack)">
          <span class="row-name">{{ palletRack.label }}</span>
          <span class="row-meta" v-if="palletRack.row">Row {{ palletRack.row }}</span>
        </div>
      </div>

      <!-- Step 2: subsection list -->
      <div class="select-list" v-if="mv_step === 'sub'">
        <div v-for="sub in mv_subs" :key="sub.id" class="select-row" @click="mvPickSub(sub)">
          <span class="row-name">Sub {{ sub.number }}</span>
          <span class="row-meta">{{ sub.shelves.length }} shelf{{ sub.shelves.length !== 1 ? 'ves' : '' }}</span>
        </div>
      </div>

      <!-- Step 3: shelf list -->
      <div class="select-list" v-if="mv_step === 'shelf'">
        <div v-for="shelf in mv_shelves" :key="shelf.id"
             class="select-row" :class="{ 'move-dest-disabled': mv_isSrcShelf(shelf) }"
             @click="mvPickShelf(shelf)">
          <span class="row-name">{{ shelf.label }}</span>
          <span class="row-meta">
            {{ mv_isSrcShelf(shelf) ? 'current shelf' : shelf.items.length + ' item' + (shelf.items.length !== 1 ? 's' : '') }}
          </span>
        </div>
      </div>

      <div class="modal-actions">
        <button class="btn-cancel" @click="mvBack">‚Üê Back</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê Zone actions ‚ïê‚ïê -->
  <div class="modal-overlay" v-show="m_zoneAct">
    <div class="modal">
      <button class="modal-close" @click="closeAllModals" title="Close">&#x2715;</button>
      <p class="modal-title">{{ mc_zoneActTitle }}</p>
      <p class="modal-subtitle">{{ mc_zoneActSub }}</p>
      <div class="action-btn-group">
        <button class="action-btn add" @click="openAddZoneItem">
          <span class="action-icon">Ôºã</span>Add Item
        </button>
        <button class="action-btn rem" @click="openZoneItemList">
          <span class="action-icon">&#x2261;</span>Manage Items
        </button>
      </div>
      <div class="modal-actions">
        <button class="btn-cancel" @click="closeAllModals">Close</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê Zone manage items ‚ïê‚ïê -->
  <div class="modal-overlay" v-show="m_zoneItems">
    <div class="modal">
      <button class="modal-close" @click="closeAllModals" title="Close">&#x2715;</button>
      <p class="modal-title">{{ mc_zoneItemsTitle }}</p>
      <p class="modal-subtitle">Click to select ¬∑ Ctrl+Click for multiple</p>
      <div class="item-list">
        <p v-if="mc_zoneItemList.length === 0" class="no-items-msg">No items in this zone.</p>
        <div v-for="item in mc_zoneItemList" :key="item.id"
             class="item-row" :class="{ selected: mc_selZoneItemIds.includes(item.id) }"
             @click="toggleZoneItemSel(item.id, $event.ctrlKey || $event.metaKey)">
          <span class="item-id-label">{{ item.itemId }}</span>
          <span class="item-meta">{{ [item.type, item.category].filter(Boolean).join(' ¬∑ ') }}</span>
          <span v-if="item.notes" class="item-meta" style="font-style:italic">{{ item.notes }}</span>
        </div>
      </div>
      <div class="selected-count">{{ mc_zoneSelCount }} selected</div>
      <div class="modal-actions">
        <button class="btn-cancel" @click="backToZoneActions">‚Üê Back</button>
        <button class="btn-danger" :disabled="mc_zoneSelCount === 0" @click="confirmRemoveZoneItems">Remove Selected</button>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ Search results strip ‚îÄ‚îÄ -->
  <div class="search-results" :class="{ hidden: !showSearchResults || searchResults.length === 0 }">
    <div v-for="(result, idx) in searchResults" :key="idx"
         class="search-result-card" :style="result.cardStyle">
      <div class="result-line" v-html="result.html" @click="scrollToResult(result)" style="cursor:pointer;flex:1;min-width:0;"></div>
      <button v-if="result.item && result.shelf" class="btn-result-view"
              @click.stop="openItemDetailFromSearch(result.item, result.shelf)">View</button>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ Console log strip ‚îÄ‚îÄ -->
  <div class="app-console" ref="consoleEl">
    <div v-for="(entry, i) in consoleLogs" :key="i" class="console-entry" :class="entry.type">
      <span class="console-time">{{ entry.time }}</span>
      <span class="console-msg">{{ entry.text }}</span>
    </div>
    <div v-if="consoleLogs.length === 0" class="console-entry console-placeholder">
      Console ready.
    </div>
  </div>

</div><!-- #app -->

<script src="warehouse.js"></script>
</body>
</html>
